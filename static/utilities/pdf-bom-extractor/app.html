<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>PDF BOM Extractor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
      if (window.pdfjsLib) {
        window.pdfjsLib.GlobalWorkerOptions.workerSrc =
          'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      }
    </script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {sans: ['Inter', 'system-ui', 'sans-serif']},
          },
        },
      };
    </script>
    <style>
      body {
        font-family: 'Inter', system-ui, sans-serif;
        background: #f8fafc;
        color: #0f172a;
      }
      .loading-spin {
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const {useEffect, useMemo, useState} = React;

      const HEADER_KEYWORDS = [
        'ITEM',
        'NO.',
        'POS',
        'Поз',
        'QTY',
        'QUANTITY',
        'Кол',
        'Кол-во',
        'PART',
        'IDNUMBER',
        'NUMBER',
        'Номер',
        'DESCRIPTION',
        'TITLE',
        'NAME',
        'Наименование',
        'MATERIAL',
        'MAT',
        'Материал',
        'MASS',
        'WEIGHT',
        'WT',
        'Масса',
        'Вес',
        'REMARK',
        'NOTE',
        'Примечание',
      ];

      const MASS_KEYWORDS = ['MASS', 'WEIGHT', 'WT', 'Масса', 'Вес'];

      const FOOTER_KEYWORDS = [
        'REVISION',
        'DATE',
        'DRAWN',
        'CHECKED',
        'APPROVED',
        'SCALE',
        'SHEET',
        'Лист',
        'Листов',
        'ЭП.',
        'Сост',
        'Разраб.',
        'Пров.',
        'Утв.',
        'TOTAL MASS',
        'Итого масса',
        'TECHNICAL REQUIREMENTS',
        'Технические требования',
        'TIGHTENING TORQUE',
        'PRESSURE GAUGE',
        'WATER INLET',
        'WATER OUTLET',
        'AS-BUILT',
        'DEBURR',
        'UNSPECIFIED',
        'TOLERANCE',
        'AUTHOR',
        'OTHER TIGHTENING',
        'THREADED HOLE',
      ];

      const cleanStr = (str) => str.replace(/\s+/g, '').toUpperCase();

      const findHeaderY = (items) => {
        const candidates = [];
        items.forEach((item) => {
          const clean = cleanStr(item.str);
          const isKeyword = HEADER_KEYWORDS.some((k) => clean.includes(k));
          if (isKeyword) {
            const existing = candidates.find((c) => Math.abs(c.y - item.y) < 5);
            if (existing) {
              existing.score += 1;
            } else {
              candidates.push({y: item.y, score: 1});
            }
          }
        });
        candidates.sort((a, b) => b.score - a.score);
        return candidates.length > 0 && candidates[0].score >= 2 ? candidates[0].y : null;
      };

      const optimizeAndCutoff = (rows, cols) => {
        if (!rows.length || !cols.length) return {cleanedRows: rows, hiddenRows: [], cutCount: 0};

        const itemColName = cols[0];
        let maxItemNum = 0;
        let cutIndex = -1;

        const descColName =
          cols.find((c) =>
            ['DESCRIPTION', 'TITLE', 'NAME', 'Наименование'].some((k) =>
              c.toUpperCase().includes(k),
            ),
          ) || cols[1];

        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          const itemVal = (row.data[itemColName] || '').trim();
          const descVal = (row.data[descColName] || '').trim().toUpperCase();
          const fullRowText = Object.values(row.data)
            .join(' ')
            .toUpperCase();

          const isNumber = /^\d+$/.test(itemVal);
          const num = isNumber ? parseInt(itemVal, 10) : 0;

          if (isNumber && maxItemNum > 5 && num < maxItemNum && num <= 1) {
            cutIndex = i;
            break;
          }

          if (!itemVal) {
            const isBulletPoint = descVal.startsWith('*') || descVal.startsWith('-');
            const hasFooterKeyword = FOOTER_KEYWORDS.some((kw) => fullRowText.includes(kw));
            if (isBulletPoint || hasFooterKeyword) {
              cutIndex = i;
              break;
            }
          }

          if (isNumber && num > maxItemNum) {
            maxItemNum = num;
          }
        }

        if (cutIndex !== -1) {
          return {
            cleanedRows: rows.slice(0, cutIndex),
            hiddenRows: rows.slice(cutIndex),
            cutCount: rows.length - cutIndex,
          };
        }
        return {cleanedRows: rows, hiddenRows: [], cutCount: 0};
      };

      const ICONS = {
        'upload-cloud':
          'M20 16.58a5 5 0 0 0-3-9.58 6 6 0 0 0-11.31 2A4 4 0 0 0 4 16h4v-4l4 4 4-4v4z',
        'upload': 'M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2M7 9l5-5 5 5M12 4v12',
        'loader-2': 'M21 12a9 9 0 1 1-6.219-8.56M12 3v3',
        'alert-circle': 'M12 9v4M12 17h.01M22 12A10 10 0 1 1 2 12a10 10 0 0 1 20 0Z',
        download: 'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3',
        'file-text': 'M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8Zm0 0 6 6M8 13h8M8 17h5M8 9h1',
        'table-2': 'M21 3H3v18h18zm-9 0v18m9-9H3M9 3v18',
        eye: 'M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z M12 15a3 3 0 1 1 0-6 3 3 0 0 1 0 6z',
        'eye-off':
          'M3 3l18 18M10.58 10.58a2 2 0 0 0 2.84 2.84M9.88 4.12A9.8 9.8 0 0 1 12 4c7 0 11 7 11 7a18.4 18.4 0 0 1-1.64 2.88M6.17 6.17A18.7 18.7 0 0 0 1 11s4 7 11 7a10.5 10.5 0 0 0 3.5-.59',
        scissors:
          'M4 20c1.38 0 2.5-1.12 2.5-2.5S5.38 15 4 15 1.5 16.12 1.5 17.5 2.62 20 4 20zm0-10c1.38 0 2.5-1.12 2.5-2.5S5.38 5 4 5 1.5 6.12 1.5 7.5 2.62 10 4 10zm3.5-2.5 13.5-5M7.5 14l13.5 5M8 12l8-8m-2 10 7-7',
        'trash-2':
          'M3 6h18M8 6v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6M10 6V4a2 2 0 0 1 2-2h0a2 2 0 0 1 2 2v2M10 11v6M14 11v6',
        'check-square': 'M9 11l3 3L22 4M3 12v7a2 2 0 0 0 2 2h14',
        square: 'M5 3h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z',
        x: 'M18 6 6 18M6 6l12 12',
      };

      const Icon = ({name, size = 16, className = ''}) => {
        const d = ICONS[name];
        if (!d) return null;
        return (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width={size}
            height={size}
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
            className={className}
            aria-hidden="true"
          >
            {d.includes('M') || d.includes('m') ? (
              d.split(' ').some((chunk) => chunk.includes('z')) ? (
                <path d={d} />
              ) : (
                <path d={d} />
              )
            ) : (
              <path d={d} />
            )}
          </svg>
        );
      };

      function App() {
        const [isSdkReady, setIsSdkReady] = useState(false);
        const [globalError, setGlobalError] = useState(null);
        const [files, setFiles] = useState([]);
        const [activeFileId, setActiveFileId] = useState(null);
        const [isDebugMode, setIsDebugMode] = useState(false);
        const [lastSelectedId, setLastSelectedId] = useState(null);

        useEffect(() => {
          if ((window || {}).pdfjsLib) {
            setIsSdkReady(true);
          } else {
            setGlobalError('PDF.js failed to load.');
          }
        }, []);

        const processSingleFile = async (file) => {
          try {
            const buf = await file.arrayBuffer();
            const pdfjs = window.pdfjsLib;
            const pdf = await pdfjs.getDocument(buf).promise;

            let allRows = [];
            let finalColumns = [];
            let rawItems = [];
            let debugHY = null;
            let debugCols = [];

            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const content = await page.getTextContent();
              if (content.items.length === 0) continue;

              const items = content.items.map((item) => ({
                str: item.str,
                x: item.transform[4],
                y: item.transform[5],
                width: item.width,
                height: item.height,
              }));

              if (i === 1) rawItems = items;

              const headerY = findHeaderY(items);
              if (!headerY) continue;
              if (i === 1) debugHY = headerY;

              let headerItems = items.filter((item) => Math.abs(item.y - headerY) < 5);
              headerItems.sort((a, b) => a.x - b.x);
              headerItems = headerItems.filter((it) => it.str.trim().length > 1);

              const cols = headerItems.map((it) => ({name: it.str.trim(), x: it.x}));
              if (cols.length < 2) continue;

              finalColumns = cols.map((c) => c.name);
              if (i === 1) debugCols = cols.map((c) => c.x);

              const dataItems = items.filter((item) => item.y < headerY - 10);
              const rowsMap = new Map();

              dataItems.forEach((item) => {
                let rowY = -1;
                for (const y of rowsMap.keys()) {
                  if (Math.abs(y - item.y) < 6) {
                    rowY = y;
                    break;
                  }
                }
                if (rowY === -1) rowsMap.set(item.y, [item]);
                else rowsMap.get(rowY).push(item);
              });

              const sortedRows = Array.from(rowsMap.entries())
                .sort((a, b) => b[0] - a[0])
                .map(([y, rowItems]) => {
                  const rowData = {};
                  rowItems.forEach((it) => {
                    let targetColIndex = -1;
                    for (let c = 0; c < cols.length; c++) {
                      if (it.x >= cols[c].x - 15) {
                        targetColIndex = c;
                      } else {
                        break;
                      }
                    }
                    if (targetColIndex !== -1) {
                      const colName = cols[targetColIndex].name;
                      rowData[colName] = rowData[colName] ? rowData[colName] + ' ' + it.str : it.str;
                    }
                  });

                  Object.keys(rowData).forEach((key) => {
                    let val = rowData[key];
                    const isMassCol = MASS_KEYWORDS.some((k) => key.toUpperCase().includes(k));
                    if (isMassCol) {
                      val = val.replace(/[a-zA-Z?-??-?]/g, '');
                    }
                    rowData[key] = val.trim();
                  });

                  return {id: Math.random(), y, data: rowData};
                });

              const validRows = sortedRows.filter(
                (r) => Object.values(r.data).join('').trim().length > 0,
              );
              allRows = [...allRows, ...validRows];
            }

            const {cleanedRows, hiddenRows, cutCount} = optimizeAndCutoff(allRows, finalColumns);
            const normalizedRows = cleanedRows.map((r, idx) => ({...r, id: idx}));

            return {
              status: 'done',
              rows: normalizedRows,
              hiddenRows,
              columns: finalColumns,
              cutoffCount: cutCount,
              rawDebugItems: rawItems,
              debugHeaderY: debugHY,
              debugCols,
            };
          } catch (e) {
            return {status: 'error', errorMessage: e?.message || 'Processing error'};
          }
        };

        const handleFileUpload = async (e) => {
          if (!e.target.files?.length) return;

          const newFiles = Array.from(e.target.files).map((file) => ({
            id: Math.random().toString(36).slice(2, 11),
            file,
            status: 'processing',
            rows: [],
            hiddenRows: [],
            columns: [],
            cutoffCount: 0,
            selectedRowIds: new Set(),
          }));

          setFiles((prev) => [...prev, ...newFiles]);
          if (!activeFileId && newFiles.length > 0) setActiveFileId(newFiles[0].id);

          for (const pFile of newFiles) {
            const result = await processSingleFile(pFile.file);
            setFiles((prev) =>
              prev.map((f) => (f.id === pFile.id ? {...f, ...result} : f)),
            );
          }
        };

        const activeFile = useMemo(
          () => files.find((f) => f.id === activeFileId),
          [files, activeFileId],
        );

        const toggleSelectAll = () => {
          if (!activeFile) return;
          setFiles((prev) =>
            prev.map((f) => {
              if (f.id !== activeFileId) return f;
              const newSet = new Set();
              if (f.selectedRowIds.size !== f.rows.length) {
                f.rows.forEach((r) => newSet.add(r.id));
              }
              return {...f, selectedRowIds: newSet};
            }),
          );
        };

        const handleRowClick = (rowId, event) => {
          if (!activeFile) return;
          setFiles((prev) =>
            prev.map((f) => {
              if (f.id !== activeFileId) return f;
              const newSet = new Set(f.selectedRowIds);
              if (event.shiftKey && lastSelectedId !== null) {
                const start = Math.min(lastSelectedId, rowId);
                const end = Math.max(lastSelectedId, rowId);
                for (let i = start; i <= end; i++) newSet.add(i);
              } else {
                if (newSet.has(rowId)) newSet.delete(rowId);
                else newSet.add(rowId);
              }
              return {...f, selectedRowIds: newSet};
            }),
          );
          setLastSelectedId(rowId);
        };

        const deleteSelectedRows = () => {
          if (!activeFile) return;
          setFiles((prev) =>
            prev.map((f) => {
              if (f.id !== activeFileId) return f;
              return {
                ...f,
                rows: f.rows.filter((r) => !f.selectedRowIds.has(r.id)),
                selectedRowIds: new Set(),
              };
            }),
          );
        };

        const restoreHiddenRows = () => {
          if (!activeFile) return;
          setFiles((prev) =>
            prev.map((f) => {
              if (f.id !== activeFileId) return f;
              const restored = f.hiddenRows.map((r, idx) => ({
                ...r,
                id: f.rows.length + idx + 1000,
              }));
              return {
                ...f,
                rows: [...f.rows, ...restored],
                hiddenRows: [],
                cutoffCount: 0,
              };
            }),
          );
        };

        const removeFile = (id, event) => {
          event.stopPropagation();
          setFiles((prev) => prev.filter((f) => f.id !== id));
          if (activeFileId === id) setActiveFileId(null);
        };

        const downloadSingleCsv = (fileId, event) => {
          event?.stopPropagation();
          const fileData = files.find((f) => f.id === fileId);
          if (!fileData || !fileData.rows.length) return;

          const header = fileData.columns.join(';') + '\n';
          const body = fileData.rows
            .map((row) =>
              fileData.columns
                .map((col) => `"${(row.data[col] || '').replace(/"/g, '""')}"`)
                .join(';'),
            )
            .join('\n');

          const blob = new Blob([new Uint8Array([0xef, 0xbb, 0xbf]), header + body], {
            type: 'text/csv',
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          const originalName = fileData.file.name.replace(/\.[^/.]+$/, '');
          a.href = url;
          a.download = `${originalName}_spec.csv`;
          a.click();
        };

        const downloadGeneralReport = () => {
          const allColumnsSet = new Set();
          allColumnsSet.add('FILE_NAME');
          files.forEach((f) => f.columns.forEach((c) => allColumnsSet.add(c)));
          const allColumns = Array.from(allColumnsSet);

          let csvContent = allColumns.join(';') + '\n';
          files.forEach((f) => {
            if (f.status !== 'done') return;
            f.rows.forEach((row) => {
              const rowStr = allColumns
                .map((col) => {
                  if (col === 'FILE_NAME') return `"${f.file.name}"`;
                  return `"${(row.data[col] || '').replace(/"/g, '""')}"`;
                })
                .join(';');
              csvContent += rowStr + '\n';
            });
          });

          const blob = new Blob([new Uint8Array([0xef, 0xbb, 0xbf]), csvContent], {
            type: 'text/csv',
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `GENERAL_REPORT_${new Date().toISOString().slice(0, 10)}.csv`;
          a.click();
        };

        if (globalError) {
          return (
            <div className="min-h-screen flex items-center justify-center">
              <div className="bg-red-50 text-red-700 px-6 py-4 rounded-lg shadow-sm border border-red-100">
                {globalError}
              </div>
            </div>
          );
        }

        return (
          <div
            className="bg-gray-50 flex flex-col font-sans text-gray-800 overflow-hidden"
            style={{zoom: 0.72, height: '153vh'}}
          >
            <header className="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-sm z-10 shrink-0">
              <div className="flex items-center gap-3">
                <h1 className="text-xl font-bold flex gap-2 items-center text-gray-800">
                  <Icon name="table-2" size={24} className="text-blue-600" />
                  PDF BOM Extractor
                </h1>
                <span className="bg-blue-100 text-blue-700 text-xs px-2 py-0.5 rounded-full font-medium border border-blue-200">
                  Beta
                </span>
              </div>
              <div className="flex gap-4">
                <button
                  onClick={() => setIsDebugMode((v) => !v)}
                  className={`flex items-center gap-2 px-3 py-1.5 rounded text-sm transition-colors ${
                    isDebugMode
                      ? 'bg-yellow-100 text-yellow-800 border border-yellow-300'
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }`}
                >
                  <Icon name={isDebugMode ? 'eye-off' : 'eye'} size={16} />
                  <span>Debug</span>
                </button>
              </div>
            </header>

            <div className="flex flex-1 overflow-hidden">
              <main className="flex-1 flex flex-col overflow-hidden relative bg-gray-50/50">
                {!files.length ? (
                  <div className="flex-1 flex flex-col items-center justify-center p-10">
                    <div className="border-4 border-dashed border-gray-200 rounded-2xl p-12 text-center hover:bg-blue-50/50 hover:border-blue-200 transition-all cursor-pointer group relative">
                      <input
                        type="file"
                        accept=".pdf"
                        multiple
                        onChange={handleFileUpload}
                        className="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                      />
                      <div className="w-20 h-20 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform">
                        <Icon name="upload-cloud" size={40} />
                      </div>
                      <h2 className="text-2xl font-bold text-gray-700 mb-2">Upload Drawings</h2>
                      <p className="text-gray-400 max-w-sm mx-auto">
                        Drag and drop one or more PDF files here to extract specifications
                      </p>
                    </div>
                  </div>
                ) : activeFile ? (
                  <div className="flex-1 flex flex-col overflow-hidden">
                    <div className="bg-white border-b px-6 py-3 flex justify-between items-center h-16 shrink-0">
                      <div>
                        <h2 className="font-bold text-lg flex items-center gap-2">
                          <Icon name="file-text" size={20} className="text-gray-400" />
                          {activeFile.file.name}
                        </h2>
                        <div className="text-xs text-gray-400 flex gap-2 items-center mt-1">
                          <span>Rows: {activeFile.rows.length}</span>
                          {activeFile.cutoffCount > 0 && (
                            <>
                              <span className="text-gray-300 mx-2">|</span>
                              <button
                                onClick={restoreHiddenRows}
                                className="text-blue-500 hover:text-blue-700 hover:underline cursor-pointer flex items-center gap-1 transition-colors group"
                                title="Click to restore removed rows"
                              >
                                <Icon
                                  name="scissors"
                                  size={12}
                                  className="group-hover:rotate-45 transition-transform"
                                />
                                • Trimmed footer: {activeFile.cutoffCount} (Restore)
                              </button>
                            </>
                          )}
                        </div>
                      </div>
                      <div className="flex gap-2">
                        {activeFile.selectedRowIds.size > 0 && (
                          <button
                            onClick={deleteSelectedRows}
                            className="bg-red-50 text-red-600 px-3 py-1.5 rounded-md text-sm font-medium hover:bg-red-100 flex items-center gap-2"
                          >
                            <Icon name="trash-2" size={16} />
                            Delete ({activeFile.selectedRowIds.size})
                          </button>
                        )}
                      </div>
                    </div>

                    {isDebugMode && activeFile.rawDebugItems && (
                      <div className="h-64 bg-gray-900 border-b border-gray-800 relative overflow-hidden shrink-0">
                        <div className="absolute top-2 left-2 z-10 bg-yellow-500 text-black text-xs px-2 py-1 rounded font-bold pointer-events-none">
                          RAW PDF VIEW
                        </div>
                        <div className="relative w-full h-full transform scale-75 origin-top-left overflow-auto p-4">
                          {activeFile.rawDebugItems.map((item, idx) => (
                            <div
                              key={idx}
                              className="absolute whitespace-nowrap text-green-400 font-mono text-xs border border-transparent hover:border-white"
                              style={{left: item.x, bottom: item.y, fontSize: '10px'}}
                            >
                              {item.str}
                            </div>
                          ))}
                          {activeFile.debugHeaderY && (
                            <div
                              className="absolute w-full border-b-2 border-red-500"
                              style={{bottom: activeFile.debugHeaderY}}
                            />
                          )}
                          {activeFile.debugCols?.map((x, i) => (
                            <div
                              key={i}
                              className="absolute h-full border-l border-blue-500 border-dashed opacity-50"
                              style={{left: x}}
                            />
                          ))}
                        </div>
                      </div>
                    )}

                    <div className="flex-1 overflow-auto p-6">
                      {activeFile.status === 'processing' ? (
                        <div className="flex flex-col items-center justify-center h-full text-gray-400 gap-3">
                          <Icon name="loader-2" size={32} className="text-blue-500 loading-spin" />
                          Processing file...
                        </div>
                      ) : activeFile.status === 'error' ? (
                        <div className="flex flex-col items-center justify-center h-full text-red-500 gap-2">
                          <Icon name="alert-circle" size={40} />
                          <p>{activeFile.errorMessage || 'Processing error'}</p>
                        </div>
                      ) : (
                        <div className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-x-auto">
                          <table className="min-w-full text-sm min-w-max">
                            <thead className="bg-gray-50 border-b border-gray-200">
                              <tr>
                                <th className="w-12 py-3 px-4 text-center">
                                  <button
                                    onClick={toggleSelectAll}
                                    className="text-gray-400 hover:text-blue-600"
                                  >
                                    {activeFile.selectedRowIds.size === activeFile.rows.length &&
                                    activeFile.rows.length > 0 ? (
                                      <Icon name="check-square" size={18} />
                                    ) : (
                                      <Icon name="square" size={18} />
                                    )}
                                  </button>
                                </th>
                                {activeFile.columns.map((c) => (
                                  <th
                                    key={c}
                                    className="px-4 py-3 text-left font-semibold text-gray-500 uppercase text-xs tracking-wider"
                                  >
                                    {c}
                                  </th>
                                ))}
                              </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                              {activeFile.rows.map((row) => {
                                const isSelected = activeFile.selectedRowIds.has(row.id);
                                return (
                                  <tr
                                    key={row.id}
                                    onClick={(e) => handleRowClick(row.id, e)}
                                    className={`hover:bg-gray-50 cursor-pointer transition-colors ${
                                      isSelected ? 'bg-blue-50' : ''
                                    }`}
                                  >
                                    <td className="text-center py-2">
                                      <div className="flex justify-center">
                                        {isSelected ? (
                                          <Icon
                                            name="check-square"
                                            size={16}
                                            className="text-blue-600"
                                          />
                                        ) : (
                                          <Icon name="square" size={16} className="text-gray-300" />
                                        )}
                                      </div>
                                    </td>
                                    {activeFile.columns.map((c) => (
                                      <td
                                        key={c}
                                        className="px-4 py-2 text-gray-700 whitespace-pre-wrap max-w-xs truncate"
                                      >
                                        {row.data[c]}
                                      </td>
                                    ))}
                                  </tr>
                                );
                              })}
                            </tbody>
                          </table>
                        </div>
                      )}
                    </div>
                  </div>
                ) : (
                  <div className="flex-1 flex items-center justify-center text-gray-400">
                    Select a file from the sidebar to view
                  </div>
                )}
              </main>

              <aside className="w-80 bg-white border-l border-gray-200 flex flex-col shrink-0 z-20 shadow-xl">
                <div className="p-4 border-b border-gray-100 bg-gray-50">
                  <h3 className="font-bold text-gray-700 flex items-center justify-between">
                    Files ({files.length})
                    <label className="text-xs text-blue-600 font-medium cursor-pointer hover:underline flex items-center gap-1">
                      <Icon name="upload" size={12} />
                      Add
                      <input
                        type="file"
                        multiple
                        accept=".pdf"
                        className="hidden"
                        onChange={handleFileUpload}
                      />
                    </label>
                  </h3>
                </div>

                <div className="flex-1 overflow-y-auto p-2 space-y-2">
                  {files.map((f) => (
                    <div
                      key={f.id}
                      onClick={() => setActiveFileId(f.id)}
                      className={`group relative p-3 rounded-lg cursor-pointer border transition-all ${
                        activeFileId === f.id
                          ? 'bg-blue-50 border-blue-200 shadow-sm'
                          : 'bg-white border-transparent hover:bg-gray-50 hover:border-gray-200'
                      }`}
                    >
                      <div className="flex justify-between items-start mb-1">
                        <div className="font-medium text-sm truncate pr-6 text-gray-700">
                          {f.file.name}
                        </div>
                        <button
                          onClick={(e) => removeFile(f.id, e)}
                          className="text-gray-300 hover:text-red-500 absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity"
                        >
                          <Icon name="x" size={14} />
                        </button>
                      </div>

                      <div className="flex justify-between items-end">
                        <div className="text-xs">
                          {f.status === 'processing' && (
                            <span className="text-blue-500 flex items-center gap-1">
                              <Icon name="loader-2" size={10} className="loading-spin" /> Processing...
                            </span>
                          )}
                          {f.status === 'error' && <span className="text-red-500">Error</span>}
                          {f.status === 'done' && <span className="text-gray-400">{f.rows.length} rows</span>}
                        </div>

                        {f.status === 'done' && (
                          <button
                            onClick={(e) => downloadSingleCsv(f.id, e)}
                            className="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-100 rounded-md transition-colors"
                            title="Download this CSV"
                          >
                            <Icon name="download" size={14} />
                          </button>
                        )}
                      </div>
                    </div>
                  ))}
                </div>

                {files.some((f) => f.status === 'done') && (
                  <div className="p-4 border-t border-gray-200 bg-gray-50">
                    <button
                      onClick={downloadGeneralReport}
                      className="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center gap-2 shadow-sm transition-transform active:scale-95"
                    >
                      <Icon name="download" size={16} />
                      Download Master Report
                    </button>
                    <p className="text-[10px] text-gray-400 text-center mt-2">
                      Merges all tables into one CSV file
                    </p>
                  </div>
                )}
              </aside>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
