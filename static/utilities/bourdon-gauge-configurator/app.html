<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Bourdon Gauge Configurator</title>
  <script src="../../vendor/jspdf.umd.min.js"></script>
  <script src="../../vendor/html2canvas.min.js"></script>
  <script src="../../vendor/react.production.min.js"></script>
  <script src="../../vendor/react-dom.production.min.js"></script>
  <script src="../../vendor/babel.min.js"></script>
  <script src="../../vendor/tailwindcss.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
        },
      },
    };
  </script>
  <style>
    body {
      margin: 0;
      font-family: 'Inter', system-ui, sans-serif;
      background: #0f1115;
      color: #e5e7eb;
    }
  </style>
</head>

<body>
  <div id="root"></div>
  <script type="text/babel">
const { useState, useMemo, useEffect, useRef } = React;

const ICONS = {
  "settings": [
    [
      "path",
      {
        "d": "M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915",
        "key": "1i5ecw"
      }
    ],
    [
      "circle",
      {
        "cx": "12",
        "cy": "12",
        "r": "3",
        "key": "1v7zrd"
      }
    ]
  ],
  "download": [
    [
      "path",
      {
        "d": "M12 15V3",
        "key": "m9g1x1"
      }
    ],
    [
      "path",
      {
        "d": "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",
        "key": "ih7n3h"
      }
    ],
    [
      "path",
      {
        "d": "m7 10 5 5 5-5",
        "key": "brsn70"
      }
    ]
  ],
  "gauge": [
    [
      "path",
      {
        "d": "m12 14 4-4",
        "key": "9kzdfg"
      }
    ],
    [
      "path",
      {
        "d": "M3.34 19a10 10 0 1 1 17.32 0",
        "key": "19p75a"
      }
    ]
  ],
  "ruler": [
    [
      "path",
      {
        "d": "M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0Z",
        "key": "icamh8"
      }
    ],
    [
      "path",
      {
        "d": "m14.5 12.5 2-2",
        "key": "inckbg"
      }
    ],
    [
      "path",
      {
        "d": "m11.5 9.5 2-2",
        "key": "fmmyf7"
      }
    ],
    [
      "path",
      {
        "d": "m8.5 6.5 2-2",
        "key": "vc6u1g"
      }
    ],
    [
      "path",
      {
        "d": "m17.5 15.5 2-2",
        "key": "wo5hmg"
      }
    ]
  ],
  "droplets": [
    [
      "path",
      {
        "d": "M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.84-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z",
        "key": "1ptgy4"
      }
    ],
    [
      "path",
      {
        "d": "M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97",
        "key": "1sl1rz"
      }
    ]
  ],
  "maximize-2": [
    [
      "path",
      {
        "d": "M15 3h6v6",
        "key": "1q9fwt"
      }
    ],
    [
      "path",
      {
        "d": "m21 3-7 7",
        "key": "1l2asr"
      }
    ],
    [
      "path",
      {
        "d": "m3 21 7-7",
        "key": "tjx5ai"
      }
    ],
    [
      "path",
      {
        "d": "M9 21H3v-6",
        "key": "wtvkvv"
      }
    ]
  ],
  "circle-check": [
    [
      "circle",
      {
        "cx": "12",
        "cy": "12",
        "r": "10",
        "key": "1mglay"
      }
    ],
    [
      "path",
      {
        "d": "m9 12 2 2 4-4",
        "key": "dzmm74"
      }
    ]
  ],
  "file-text": [
    [
      "path",
      {
        "d": "M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z",
        "key": "1oefj6"
      }
    ],
    [
      "path",
      {
        "d": "M14 2v5a1 1 0 0 0 1 1h5",
        "key": "wfsgrz"
      }
    ],
    [
      "path",
      {
        "d": "M10 9H8",
        "key": "b1mrlr"
      }
    ],
    [
      "path",
      {
        "d": "M16 13H8",
        "key": "t4e002"
      }
    ],
    [
      "path",
      {
        "d": "M16 17H8",
        "key": "z1uh3a"
      }
    ]
  ],
  "info": [
    [
      "circle",
      {
        "cx": "12",
        "cy": "12",
        "r": "10",
        "key": "1mglay"
      }
    ],
    [
      "path",
      {
        "d": "M12 16v-4",
        "key": "1dtifu"
      }
    ],
    [
      "path",
      {
        "d": "M12 8h.01",
        "key": "e9boi3"
      }
    ]
  ],
  "shield-check": [
    [
      "path",
      {
        "d": "M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",
        "key": "oel41y"
      }
    ],
    [
      "path",
      {
        "d": "m9 12 2 2 4-4",
        "key": "dzmm74"
      }
    ]
  ],
  "chevron-right": [
    [
      "path",
      {
        "d": "m9 18 6-6-6-6",
        "key": "mthhwq"
      }
    ]
  ],
  "lock": [
    [
      "rect",
      {
        "width": "18",
        "height": "11",
        "x": "3",
        "y": "11",
        "rx": "2",
        "ry": "2",
        "key": "1w4ew1"
      }
    ],
    [
      "path",
      {
        "d": "M7 11V7a5 5 0 0 1 10 0v4",
        "key": "fwvmzm"
      }
    ]
  ],
  "unlock": [
    [
      "rect",
      {
        "width": "18",
        "height": "11",
        "x": "3",
        "y": "11",
        "rx": "2",
        "ry": "2",
        "key": "1w4ew1"
      }
    ],
    [
      "path",
      {
        "d": "M7 11V7a5 5 0 0 1 9.9-1",
        "key": "1mm8w8"
      }
    ]
  ],
  "box": [
    [
      "path",
      {
        "d": "M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z",
        "key": "hh9hay"
      }
    ],
    [
      "path",
      {
        "d": "m3.3 7 8.7 5 8.7-5",
        "key": "g66t2b"
      }
    ],
    [
      "path",
      {
        "d": "M12 22V12",
        "key": "d0xqtd"
      }
    ]
  ],
  "hash": [
    [
      "line",
      {
        "x1": "4",
        "x2": "20",
        "y1": "9",
        "y2": "9",
        "key": "4lhtct"
      }
    ],
    [
      "line",
      {
        "x1": "4",
        "x2": "20",
        "y1": "15",
        "y2": "15",
        "key": "vyu0kd"
      }
    ],
    [
      "line",
      {
        "x1": "10",
        "x2": "8",
        "y1": "3",
        "y2": "21",
        "key": "1ggp8o"
      }
    ],
    [
      "line",
      {
        "x1": "16",
        "x2": "14",
        "y1": "3",
        "y2": "21",
        "key": "weycgp"
      }
    ]
  ],
  "user": [
    [
      "path",
      {
        "d": "M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",
        "key": "975kel"
      }
    ],
    [
      "circle",
      {
        "cx": "12",
        "cy": "7",
        "r": "4",
        "key": "17ys0d"
      }
    ]
  ],
  "clipboard-list": [
    [
      "rect",
      {
        "width": "8",
        "height": "4",
        "x": "8",
        "y": "2",
        "rx": "1",
        "ry": "1",
        "key": "tgr4d6"
      }
    ],
    [
      "path",
      {
        "d": "M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",
        "key": "116196"
      }
    ],
    [
      "path",
      {
        "d": "M12 11h4",
        "key": "1jrz19"
      }
    ],
    [
      "path",
      {
        "d": "M12 16h4",
        "key": "n85exb"
      }
    ],
    [
      "path",
      {
        "d": "M8 11h.01",
        "key": "1dfujw"
      }
    ],
    [
      "path",
      {
        "d": "M8 16h.01",
        "key": "18s6g9"
      }
    ]
  ],
  "external-link": [
    [
      "path",
      {
        "d": "M15 3h6v6",
        "key": "1q9fwt"
      }
    ],
    [
      "path",
      {
        "d": "M10 14 21 3",
        "key": "gplh6r"
      }
    ],
    [
      "path",
      {
        "d": "M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",
        "key": "a6xqqp"
      }
    ]
  ],
  "arrow-down-to-line": [
    [
      "path",
      {
        "d": "M12 17V3",
        "key": "1cwfxf"
      }
    ],
    [
      "path",
      {
        "d": "m6 11 6 6 6-6",
        "key": "12ii2o"
      }
    ],
    [
      "path",
      {
        "d": "M19 21H5",
        "key": "150jfl"
      }
    ]
  ],
  "move": [
    [
      "path",
      {
        "d": "M12 2v20",
        "key": "t6zp3m"
      }
    ],
    [
      "path",
      {
        "d": "m15 19-3 3-3-3",
        "key": "11eu04"
      }
    ],
    [
      "path",
      {
        "d": "m19 9 3 3-3 3",
        "key": "1mg7y2"
      }
    ],
    [
      "path",
      {
        "d": "M2 12h20",
        "key": "9i4pu4"
      }
    ],
    [
      "path",
      {
        "d": "m5 9-3 3 3 3",
        "key": "j64kie"
      }
    ],
    [
      "path",
      {
        "d": "m9 5 3-3 3 3",
        "key": "l8vdw6"
      }
    ]
  ],
  "tag": [
    [
      "path",
      {
        "d": "M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z",
        "key": "vktsd0"
      }
    ],
    [
      "circle",
      {
        "cx": "7.5",
        "cy": "7.5",
        "r": ".5",
        "fill": "currentColor",
        "key": "kqv944"
      }
    ]
  ],
  "pipette": [
    [
      "path",
      {
        "d": "m12 9-8.414 8.414A2 2 0 0 0 3 18.828v1.344a2 2 0 0 1-.586 1.414A2 2 0 0 1 3.828 21h1.344a2 2 0 0 0 1.414-.586L15 12",
        "key": "1y3wsu"
      }
    ],
    [
      "path",
      {
        "d": "m18 9 .4.4a1 1 0 1 1-3 3l-3.8-3.8a1 1 0 1 1 3-3l.4.4 3.4-3.4a1 1 0 1 1 3 3z",
        "key": "110lr1"
      }
    ],
    [
      "path",
      {
        "d": "m2 22 .414-.414",
        "key": "jhxm08"
      }
    ]
  ],
  "workflow": [
    [
      "rect",
      {
        "width": "8",
        "height": "8",
        "x": "3",
        "y": "3",
        "rx": "2",
        "key": "by2w9f"
      }
    ],
    [
      "path",
      {
        "d": "M7 11v4a2 2 0 0 0 2 2h4",
        "key": "xkn7yn"
      }
    ],
    [
      "rect",
      {
        "width": "8",
        "height": "8",
        "x": "13",
        "y": "13",
        "rx": "2",
        "key": "1cgmvn"
      }
    ]
  ],
  "scroll-text": [
    [
      "path",
      {
        "d": "M15 12h-5",
        "key": "r7krc0"
      }
    ],
    [
      "path",
      {
        "d": "M15 8h-5",
        "key": "1khuty"
      }
    ],
    [
      "path",
      {
        "d": "M19 17V5a2 2 0 0 0-2-2H4",
        "key": "zz82l3"
      }
    ],
    [
      "path",
      {
        "d": "M8 21h12a2 2 0 0 0 2-2v-1a1 1 0 0 0-1-1H11a1 1 0 0 0-1 1v1a2 2 0 1 1-4 0V5a2 2 0 1 0-4 0v2a1 1 0 0 0 1 1h3",
        "key": "1ph1d7"
      }
    ]
  ]
};

const Icon = ({ name, size = 16, className = '' }) => {
  const nodes = ICONS[name];
  if (!nodes) return null;
  return (
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width={size}
      height={size}
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      strokeWidth="2"
      strokeLinecap="round"
      strokeLinejoin="round"
      className={className}
      aria-hidden="true"
    >
      {nodes.map(([tag, attrs], index) => {
        const { key, ...rest } = attrs;
        return React.createElement(tag, { ...rest, key: index });
      })}
    </svg>
  );
};

const Settings = (props) => <Icon name="settings" {...props} />;
const Download = (props) => <Icon name="download" {...props} />;
const Gauge = (props) => <Icon name="gauge" {...props} />;
const Ruler = (props) => <Icon name="ruler" {...props} />;
const Droplets = (props) => <Icon name="droplets" {...props} />;
const Maximize2 = (props) => <Icon name="maximize-2" {...props} />;
const CheckCircle2 = (props) => <Icon name="circle-check" {...props} />;
const FileText = (props) => <Icon name="file-text" {...props} />;
const Info = (props) => <Icon name="info" {...props} />;
const ShieldCheck = (props) => <Icon name="shield-check" {...props} />;
const ChevronRight = (props) => <Icon name="chevron-right" {...props} />;
const Lock = (props) => <Icon name="lock" {...props} />;
const Unlock = (props) => <Icon name="unlock" {...props} />;
const Box = (props) => <Icon name="box" {...props} />;
const Hash = (props) => <Icon name="hash" {...props} />;
const User = (props) => <Icon name="user" {...props} />;
const ClipboardList = (props) => <Icon name="clipboard-list" {...props} />;
const ExternalLink = (props) => <Icon name="external-link" {...props} />;
const ArrowDownToLine = (props) => <Icon name="arrow-down-to-line" {...props} />;
const Move = (props) => <Icon name="move" {...props} />;
const Edit3 = (props) => <Icon name="edit-3" {...props} />;
const Tag = (props) => <Icon name="tag" {...props} />;
const Pipette = (props) => <Icon name="pipette" {...props} />;
const Workflow = (props) => <Icon name="workflow" {...props} />;
const ScrollText = (props) => <Icon name="scroll-text" {...props} />;

// Load external libraries for PDF generation and screenshotting
const loadScripts = () => {
  if (!window.jspdf) {
    const jspdfScript = document.createElement('script');
    jspdfScript.src = '../../vendor/jspdf.umd.min.js';
    document.head.appendChild(jspdfScript);
  }
  if (!window.html2canvas) {
    const html2canvasScript = document.createElement('script');
    html2canvasScript.src = '../../vendor/html2canvas.min.js';
    document.head.appendChild(html2canvasScript);
  }
};

const App = () => {
  const previewRef = useRef(null);
  
  // State Management
  const [isCustomRange, setIsCustomRange] = useState(false);
  const [config, setConfig] = useState({
    model: 'BTG-Standard', // Generic model name
    nominalSize: 100, // 63, 100, 160
    unit: 'bar',
    rangeMin: 0,
    rangeMax: 10,
    
    // Connection
    connection: {
      location: 'Lower', // Lower (Radial), Back (Axial)
      standard: 'G 1/2 B', // G 1/2 B, 1/2 NPT, etc.
      material: 'Stainless steel 316L'
    },
    
    // Case
    case: {
      material: 'Stainless steel 1.4301 (304)',
      filling: 'Dry', // Dry, Glycerine, Silicone
      window: 'Laminated safety glass'
    },

    // Accessories
    accessories: {
      siphon: {
        enabled: false,
        type: 'Trumpet Form (Loop)', // Trumpet (Loop), U-Form
        standard: 'DIN 16 282',
        material: 'Steel 1.0038'
      },
      valve: {
        enabled: false,
        type: 'Form A (Test Conn.)', // Form A (Test), Form B (Shut-off)
        standard: 'DIN 16 272',
        material: 'Brass'
      }
    },

    options: {
      redPointer: false,
      flange: 'None', // None, Front Flange, Rear Bracket, U-Clamp
      oxygenService: false,
      calibrationCert: true
    },

    project: {
      tagNumber: '',
      temperature: 20,
      medium: 'Gas/Liquid',
      standard: 'EN 837-1',
      certificates: 'EN 10204 3.1',
      orderNumber: '',
      operatorName: ''
    },

    otherTechnicalParams: `Design: EN837-1
Safety designation: S3 as per EN 837-2
Accuracy class: 1 as per EN 837-1
Process fluid temperature: -40...+302  degF (-40...+150  degC)
Thermal drift: +/-0,4 %/10  degC of range (starting from 68 degF - 20 degC)
Working pressure: 
100% of FSV for static pressure; 
90% of FSV for pulsating pressure
Window: safety glass
Movement: stainless steel with internal limit stops`
  });

  useEffect(() => {
    loadScripts();
  }, []);

  // Update model number based on filling
  useEffect(() => {
    setConfig(prev => ({
      ...prev,
      model: prev.case.filling === 'Dry' ? 'BTG-Standard' : 'BTG-Vibro'
    }));
  }, [config.case.filling]);

  // Constants
  const nominalSizes = [63, 100, 160];
  const units = ['bar', 'psi', 'MPa', 'kg/cm^2'];
  const mountingTypes = ['None', 'Front Flange (Panel)', 'Rear Flange (Surface)', 'U-Clamp (Panel)'];
  
  const siphonTypes = ['Trumpet Form (Loop)', 'U-Form'];
  const valveTypes = ['Form A (Test Conn.)', 'Form B (Shut-off)'];
  const accessoryMaterials = ['Steel 1.0038', 'Stainless Steel 316Ti', 'Brass'];
  
  const caseMaterials = ['Stainless steel 1.4301 (304)', 'Stainless steel 1.4404 (316)'];

  // Simplified ranges for demo
  const ranges = [
    { min: -1, max: 0, label: '-1...0 (Vacuum)' },
    { min: -1, max: 5, label: '-1...+5 (Compound)' },
    { min: 0, max: 1, label: '0...1' },
    { min: 0, max: 6, label: '0...6' },
    { min: 0, max: 10, label: '0...10' },
    { min: 0, max: 25, label: '0...25' },
    { min: 0, max: 100, label: '0...100' },
    { min: 0, max: 250, label: '0...250' },
    { min: 0, max: 600, label: '0...600' },
    { min: 0, max: 1000, label: '0...1000' },
    { min: 0, max: 1600, label: '0...1600' },
  ];

  const connectionStandards = ['G 1/4 B', 'G 1/2 B', '1/4 NPT', '1/2 NPT', 'M20x1.5'];
  const fillings = ['Dry', 'Glycerine', 'Silicone oil'];
  
  // Visual Calculations
  const visual = useMemo(() => {
    const svgSize = 600;
    
    // Adjust Center Y based on accessories enabled to fit everything
    let center = svgSize / 2;
    let scale = 1;
    
    const hasSiphon = config.accessories.siphon.enabled;
    const hasValve = config.accessories.valve.enabled;
    
    if (hasSiphon && hasValve) {
      center = 180; // Move gauge up significantly
      scale = 0.8;  // Scale down slightly
    } else if (hasSiphon || hasValve) {
      center = 220;
      scale = 0.9;
    }

    // Scale visual size based on Nominal Size (NS) relative to canvas
    let radius;
    if (config.nominalSize === 63) radius = 90 * scale;
    else if (config.nominalSize === 100) radius = 130 * scale;
    else radius = 160 * scale; // NS 160

    return {
      cx: svgSize / 2,
      cy: center,
      r: radius,
      rInner: radius * 0.92, // Bezel width
      rDial: radius * 0.85,
      stemLen: (config.nominalSize === 63 ? 40 : 50) * scale,
      stemWidth: (config.connection.standard.includes('1/2') || config.connection.standard.includes('M20') ? 22 : 16) * scale,
      scale: scale
    };
  }, [config.nominalSize, config.connection.standard, config.accessories]);

  // Handlers
  const updateConfig = (field, value) => setConfig(prev => ({ ...prev, [field]: value }));
  const updateProject = (field, value) => setConfig(prev => ({ ...prev, project: { ...prev.project, [field]: value } }));
  const updateSubConfig = (parent, field, value) => setConfig(prev => ({ ...prev, [parent]: { ...prev[parent], [field]: value } }));
  const updateAccessory = (type, field, value) => setConfig(prev => ({ 
    ...prev, 
    accessories: { 
      ...prev.accessories, 
      [type]: { ...prev.accessories[type], [field]: value } 
    } 
  }));
  const toggleAccessory = (type) => setConfig(prev => ({ 
    ...prev, 
    accessories: { 
      ...prev.accessories, 
      [type]: { ...prev.accessories[type], enabled: !prev.accessories[type].enabled } 
    } 
  }));
  const toggleOption = (opt) => setConfig(prev => ({ ...prev, options: { ...prev.options, [opt]: !prev.options[opt] } }));

  // PDF Generation
  const handleDownloadPDF = async () => {
    const { jspdf } = window;
    const html2canvas = window.html2canvas;
    if (!jspdf || !html2canvas) return;

    // Capture sketch
    const canvas = await html2canvas(previewRef.current, {
      backgroundColor: '#ffffff',
      scale: 2, 
      useCORS: true,
      logging: false,
      onclone: (clonedDoc) => {
        const el = clonedDoc.querySelector('#blueprint-capture-area');
        if (el) {
            el.style.background = '#ffffff';
            el.style.border = 'none';
        }
      }
    });
    const sketchImg = canvas.toDataURL('image/jpeg', 0.9);

    const doc = new jspdf.jsPDF({ orientation: 'p', unit: 'mm', format: 'a4', compress: true });
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 20;

    // Draw footer function (no pages args here, just logic)
    const drawFooterOnPage = (pageNum, totalPages) => {
      doc.setPage(pageNum);
      doc.setFont('helvetica', 'italic'); doc.setFontSize(8); doc.setTextColor(150);
      doc.text('cadautoscript.com', margin, pageHeight - 10);
      doc.link(margin, pageHeight - 13, 30, 5, { url: 'https://cadautoscript.com' });
      doc.text(`Page ${pageNum} of ${totalPages}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
    };

    // PAGE 1
    let y = 20;
    doc.setFont('helvetica', 'bold'); doc.setFontSize(18); doc.setTextColor(33, 150, 243);
    doc.text('TECHNICAL DATA SHEET', margin, y);
    y += 8; doc.setFontSize(9); doc.setTextColor(100);
    doc.text('BOURDON TUBE GAUGE SPECIFICATION', margin, y);
    y += 4; doc.line(margin, y, 190, y); y += 12;

    const section = (title, data) => {
      doc.setFont('helvetica', 'bold'); doc.setFontSize(11); doc.setFillColor(240);
      doc.rect(margin, y, 170, 7, 'F'); doc.setTextColor(40); doc.text(title.toUpperCase(), margin + 2, y + 5);
      y += 12; doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
      data.forEach(item => {
        doc.setTextColor(100); doc.text(item.label + ':', margin + 5, y);
        doc.setTextColor(0); doc.text(String(item.value || '-'), margin + 75, y); y += 7;
      });
      y += 5;
    };

    const textSection = (title, text) => {
      // Check if we need a new page before drawing header
      if (y > 250) { doc.addPage(); y = 20; }
      
      doc.setFont('helvetica', 'bold'); doc.setFontSize(11); doc.setFillColor(240);
      doc.rect(margin, y, 170, 7, 'F'); doc.setTextColor(40); doc.text(title.toUpperCase(), margin + 2, y + 5);
      y += 12; doc.setFont('helvetica', 'normal'); doc.setFontSize(10); doc.setTextColor(50);
      
      const lines = doc.splitTextToSize(text, 170);
      lines.forEach(line => {
        if (y > 280) { doc.addPage(); y = 20; }
        doc.text(line, margin + 2, y);
        y += 5;
      });
      y += 5;
    };

    section('1. Project Data', [
      { label: 'Tag Number', value: config.project.tagNumber },
      { label: 'Order Number', value: config.project.orderNumber },
      { label: 'Customer', value: config.project.operatorName },
      { label: 'Date', value: new Date().toLocaleDateString('en-US') }
    ]);

    section('2. Technical Specifications', [
      { label: 'Model', value: config.model },
      { label: 'Nominal Size', value: `NS ${config.nominalSize} mm` },
      { label: 'Scale Range', value: `${config.rangeMin} ... ${config.rangeMax} ${config.unit}` },
      { label: 'Accuracy Class', value: config.nominalSize === 63 ? '1.6' : '1.0' },
      { label: 'Case Filling', value: config.case.filling }
    ]);

    section('3. Materials & Connection', [
      { label: 'Mounting', value: config.options.flange },
      { label: 'Connection Location', value: config.connection.location === 'Lower' ? 'Radial (Lower)' : 'Axial (Back)' },
      { label: 'Thread Standard', value: config.connection.standard },
      { label: 'Movement Material', value: config.connection.material },
      { label: 'Case Material', value: config.case.material },
      { label: 'Window', value: config.case.window }
    ]);

    section('4. Accessories', [
       { label: 'Shut-Off Valve', value: config.accessories.valve.enabled ? `${config.accessories.valve.standard} ${config.accessories.valve.type}` : 'None' },
       { label: 'Valve Material', value: config.accessories.valve.enabled ? config.accessories.valve.material : '-' },
       { label: 'Siphon', value: config.accessories.siphon.enabled ? `${config.accessories.siphon.standard} ${config.accessories.siphon.type}` : 'None' },
       { label: 'Siphon Material', value: config.accessories.siphon.enabled ? config.accessories.siphon.material : '-' },
    ]);

    section('5. Options', [
      { label: 'Red Set Pointer', value: config.options.redPointer ? 'Yes' : 'No' },
      { label: 'Oxygen Service', value: config.options.oxygenService ? 'Yes' : 'No' },
      { label: 'Calibration Cert', value: config.options.calibrationCert ? 'Included' : 'No' },
    ]);

    textSection('6. Other Technical Parameters', config.otherTechnicalParams);

    // SKETCH PAGE (Always new page)
    doc.addPage();
    y = 20; doc.setFont('helvetica', 'bold'); doc.setFontSize(14); doc.setTextColor(33, 150, 243);
    doc.text('PRELIMINARY SKETCH', pageWidth / 2, y, { align: 'center' });
    const iW = 140; const iH = 140; 
    doc.addImage(sketchImg, 'JPEG', (pageWidth - iW) / 2, 50, iW, iH);
    
    // Add QR Code placeholder or specific notes
    doc.setFontSize(8); doc.setTextColor(150);
    doc.text('* Dimensions are for reference only. See official catalog for exact details.', margin, 200);

    // GLOBAL FOOTER LOOP
    // Calculate total pages AFTER all content is added
    const totalPages = doc.internal.getNumberOfPages();
    for (let i = 1; i <= totalPages; i++) {
        drawFooterOnPage(i, totalPages);
    }

    doc.save(`Gauge_Spec_${config.project.orderNumber || 'Draft'}.pdf`);
  };

  // Helper to generate scale ticks
  const ScaleTicks = ({ r, min, max }) => {
    // Standard Bourdon scale covers approx 270 degrees
    // Start at 225 deg (bottom left), End at -45 deg (bottom right)
    const startAngle = 225;
    const sweep = 270;
    const ticks = [];
    const majorCount = 10;
    const minorPerMajor = 4;

    const formatNumber = (num) => {
      // Avoid showing decimals for integers, max 2 decimals for floats
      return Number.isInteger(num) ? num : Number(num.toFixed(2));
    };

    for (let i = 0; i <= majorCount * minorPerMajor; i++) {
      const progress = i / (majorCount * minorPerMajor);
      const angle = startAngle - (progress * sweep);
      const isMajor = i % minorPerMajor === 0;
      
      const rad = (angle * Math.PI) / 180;
      const x1 = Math.cos(rad) * (r - (isMajor ? 12 : 6));
      const y1 = -Math.sin(rad) * (r - (isMajor ? 12 : 6));
      const x2 = Math.cos(rad) * r;
      const y2 = -Math.sin(rad) * r;

      ticks.push(
        <line 
          key={i} 
          x1={x1} y1={y1} x2={x2} y2={y2} 
          stroke={isMajor ? "#000" : "#666"} 
          strokeWidth={isMajor ? 2.5 : 1} 
        />
      );

      if (isMajor) {
        const tx = Math.cos(rad) * (r - 25);
        const ty = -Math.sin(rad) * (r - 25);
        const val = min + ((max - min) * progress);
        ticks.push(
          <text 
            key={`t-${i}`} 
            x={tx} y={ty + 4} 
            textAnchor="middle" 
            className="text-[10px] font-bold font-sans fill-black"
          >
            {formatNumber(val)}
          </text>
        );
      }
    }
    return <g>{ticks}</g>;
  };

  return (
    <div className="min-h-screen bg-[#0f0f11] text-gray-200 font-sans p-4 md:p-8 selection:bg-blue-500/30">
      
      {/* Header Bar */}
      <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center mb-10 border-b border-white/5 pb-8">
        <div className="flex items-center gap-6">
          <div className="bg-orange-600/10 p-4 rounded-2xl border border-orange-500/20 shadow-[0_0_20px_rgba(249,115,22,0.1)]">
            <Gauge className="text-orange-500 w-8 h-8" />
          </div>
          <div>
            <h1 className="text-3xl md:text-4xl font-black tracking-tighter text-white uppercase italic leading-none">
              Configurator
            </h1>
            <div className="flex items-center gap-2 text-gray-500 text-sm mt-2 uppercase tracking-widest font-bold font-mono">
              <span className="text-orange-500">Bourdon Tube Gauge</span>
              <ChevronRight size={14} />
              <span className="text-gray-400">Series {config.model}</span>
            </div>
          </div>
        </div>
        <button onClick={handleDownloadPDF} className="group mt-6 md:mt-0 flex items-center gap-3 bg-white text-black hover:bg-orange-500 hover:text-white px-8 py-4 rounded-2xl font-bold transition-all shadow-xl active:scale-95">
          <Download size={20} /> Download PDF
        </button>
      </div>

      <div className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        {/* Left Column: Configuration Controls */}
        <div className="lg:col-span-5 space-y-6 h-[calc(100vh-200px)] overflow-y-auto pr-2 custom-scrollbar">
          
          {/* Project Info */}
          <section className="bg-[#16161a] p-6 rounded-3xl shadow-xl border border-white/5">
            <h2 className="text-xs font-black mb-4 uppercase tracking-widest text-blue-400 flex items-center gap-2">
              <ClipboardList size={16} /> Project Data
            </h2>
            <div className="space-y-4">
               <div className="space-y-1">
                  <label className="text-[10px] text-gray-500 uppercase font-bold text-orange-400">Tag Number (Position)</label>
                  <div className="flex items-center gap-2 bg-[#1c1c21] border border-orange-500/30 rounded-xl p-3 focus-within:ring-2 focus-within:ring-orange-500/50">
                    <Tag size={16} className="text-orange-500"/>
                    <input 
                      type="text" 
                      value={config.project.tagNumber} 
                      onChange={(e) => updateProject('tagNumber', e.target.value)} 
                      className="w-full bg-transparent outline-none text-sm font-bold placeholder-gray-600" 
                      placeholder="e.g. PI-1001" 
                    />
                  </div>
               </div>
               <div className="grid grid-cols-2 gap-4">
                <div className="space-y-1">
                  <label className="text-[10px] text-gray-500 uppercase font-bold">Order Number</label>
                  <input type="text" value={config.project.orderNumber} onChange={(e) => updateProject('orderNumber', e.target.value)} className="w-full bg-[#1c1c21] border border-white/5 rounded-xl p-3 outline-none focus:ring-2 focus:ring-blue-500/50 text-sm" placeholder="REF-001" />
                </div>
                <div className="space-y-1">
                  <label className="text-[10px] text-gray-500 uppercase font-bold">Customer</label>
                  <input type="text" value={config.project.operatorName} onChange={(e) => updateProject('operatorName', e.target.value)} className="w-full bg-[#1c1c21] border border-white/5 rounded-xl p-3 outline-none focus:ring-2 focus:ring-blue-500/50 text-sm" />
                </div>
              </div>
            </div>
          </section>

          {/* Technical Specs */}
          <section className="bg-[#16161a] p-6 rounded-3xl shadow-xl border border-white/5">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-xs font-black uppercase tracking-widest text-orange-400 flex items-center gap-2">
                <Maximize2 size={16} /> Geometry & Range
              </h2>
            </div>
            
            <div className="space-y-4">
              {/* NS Selection */}
              <div className="space-y-2">
                <label className="text-[10px] text-gray-500 uppercase font-bold ml-1">Nominal Size (NS)</label>
                <div className="flex gap-2">
                  {nominalSizes.map(size => (
                    <button 
                      key={size}
                      onClick={() => updateConfig('nominalSize', size)}
                      className={`flex-1 py-3 rounded-xl border text-sm font-bold transition-all ${config.nominalSize === size ? 'bg-orange-600/20 border-orange-500 text-orange-500 shadow-[0_0_15px_rgba(249,115,22,0.2)]' : 'bg-[#1c1c21] border-white/5 text-gray-500 hover:bg-[#25252b]'}`}
                    >
                      {size} mm
                    </button>
                  ))}
                </div>
              </div>

              {/* Range & Unit */}
              <div className="grid grid-cols-3 gap-3">
                 <div className="col-span-1 space-y-1">
                    <label className="text-[10px] text-gray-500 uppercase font-bold ml-1">Unit</label>
                    <select value={config.unit} onChange={(e) => updateConfig('unit', e.target.value)} className="w-full bg-[#1c1c21] border border-white/5 rounded-xl p-3 outline-none text-sm font-bold">
                      {units.map(u => <option key={u}>{u}</option>)}
                    </select>
                 </div>
                 <div className="col-span-2 space-y-1">
                    <div className="flex justify-between items-end">
                      <label className="text-[10px] text-gray-500 uppercase font-bold ml-1">Range</label>
                      <button 
                        onClick={() => setIsCustomRange(!isCustomRange)} 
                        className="text-[10px] text-orange-500 font-bold uppercase hover:text-white transition-colors flex items-center gap-1 pb-1"
                      >
                         <Edit3 size={10} />
                         {isCustomRange ? 'Select Standard' : 'Set Custom'}
                      </button>
                    </div>

                    {isCustomRange ? (
                      <div className="flex gap-2">
                        <input 
                          type="number" 
                          value={config.rangeMin} 
                          onChange={(e) => updateConfig('rangeMin', Number(e.target.value))}
                          className="w-1/2 bg-[#1c1c21] border border-white/5 rounded-xl p-3 outline-none text-sm font-bold focus:border-orange-500 transition-colors"
                          placeholder="Min"
                        />
                        <input 
                          type="number" 
                          value={config.rangeMax} 
                          onChange={(e) => updateConfig('rangeMax', Number(e.target.value))}
                          className="w-1/2 bg-[#1c1c21] border border-white/5 rounded-xl p-3 outline-none text-sm font-bold focus:border-orange-500 transition-colors"
                          placeholder="Max"
                        />
                      </div>
                    ) : (
                      <select 
                        value={ranges.find(r => r.min === config.rangeMin && r.max === config.rangeMax)?.label || ''}
                        onChange={(e) => {
                          const selectedRange = ranges.find(r => r.label === e.target.value);
                          if (selectedRange) {
                              updateConfig('rangeMin', selectedRange.min);
                              updateConfig('rangeMax', selectedRange.max);
                          }
                        }} 
                        className="w-full bg-[#1c1c21] border border-white/5 rounded-xl p-3 outline-none text-sm font-bold"
                      >
                        {ranges.map((r, i) => <option key={i} value={r.label}>{r.label}</option>)}
                      </select>
                    )}
                 </div>
              </div>

               {/* Case Material */}
               <div className="space-y-1 pt-2">
                <label className="text-[10px] text-gray-500 uppercase font-bold ml-1">Case Material</label>
                <select 
                  value={config.case.material}
                  onChange={(e) => updateSubConfig('case', 'material', e.target.value)} 
                  className="w-full bg-[#1c1c21] border border-white/5 rounded-xl p-3 outline-none text-sm font-bold"
                >
                  {caseMaterials.map(m => <option key={m}>{m}</option>)}
                </select>
              </div>

              {/* Filling */}
              <div className="space-y-2 pt-2">
                <label className="text-[10px] text-gray-500 uppercase font-bold ml-1">Case Filling</label>
                <div className="grid grid-cols-3 gap-2">
                   {fillings.map(f => (
                     <button 
                      key={f}
                      onClick={() => updateSubConfig('case', 'filling', f)}
                      className={`py-2 px-1 rounded-lg border text-[10px] font-bold uppercase transition-all ${config.case.filling === f ? 'bg-blue-600/20 border-blue-500 text-blue-400' : 'bg-[#1c1c21] border-white/5 text-gray-600'}`}
                     >
                       <Droplets size={12} className={`inline mr-1 ${config.case.filling === f ? 'fill-current' : ''}`} />
                       {f === 'Silicone oil' ? 'Silicone' : f}
                     </button>
                   ))}
                </div>
              </div>
            </div>
          </section>

          {/* Connection & Mounting */}
          <section className="bg-[#16161a] p-6 rounded-3xl shadow-xl border border-white/5">
            <h2 className="text-xs font-black mb-4 uppercase tracking-widest text-green-400 flex items-center gap-2">
              <Move size={16} /> Connection & Mounting
            </h2>
            <div className="space-y-4">
              {/* Location */}
              <div className="grid grid-cols-2 gap-3">
                 <button 
                    onClick={() => updateSubConfig('connection', 'location', 'Lower')}
                    className={`p-3 rounded-xl border text-xs font-bold transition-all flex flex-col items-center gap-2 ${config.connection.location === 'Lower' ? 'bg-green-600/20 border-green-500 text-green-400' : 'bg-[#1c1c21] border-white/5 text-gray-500'}`}
                 >
                    <ArrowDownToLine size={20} />
                    <span>Radial (Lower)</span>
                 </button>
                 <button 
                    onClick={() => updateSubConfig('connection', 'location', 'Back')}
                    className={`p-3 rounded-xl border text-xs font-bold transition-all flex flex-col items-center gap-2 ${config.connection.location === 'Back' ? 'bg-green-600/20 border-green-500 text-green-400' : 'bg-[#1c1c21] border-white/5 text-gray-500'}`}
                 >
                    <div className="w-5 h-5 rounded-full border-2 border-current flex items-center justify-center"><div className="w-1 h-1 bg-current rounded-full"></div></div>
                    <span>Axial (Back)</span>
                 </button>
              </div>

               {/* Mounting Type Selector */}
               <div className="space-y-1">
                <label className="text-[10px] text-gray-500 uppercase font-bold ml-1">Mounting Type</label>
                <select 
                  value={config.options.flange}
                  onChange={(e) => updateSubConfig('options', 'flange', e.target.value)} 
                  className="w-full bg-[#1c1c21] border border-white/5 rounded-xl p-3 outline-none text-sm font-bold"
                >
                  {mountingTypes.map(m => <option key={m}>{m}</option>)}
                </select>
              </div>

              {/* Thread */}
              <div className="space-y-1">
                <label className="text-[10px] text-gray-500 uppercase font-bold ml-1">Thread Standard</label>
                <select 
                  value={config.connection.standard}
                  onChange={(e) => updateSubConfig('connection', 'standard', e.target.value)} 
                  className="w-full bg-[#1c1c21] border border-white/5 rounded-xl p-3 outline-none text-sm font-bold"
                >
                  {connectionStandards.map(s => <option key={s}>{s}</option>)}
                </select>
              </div>
            </div>
          </section>

          {/* New Accessories Section */}
          <section className="bg-[#16161a] p-6 rounded-3xl shadow-xl border border-white/5">
             <h2 className="text-xs font-black mb-4 uppercase tracking-widest text-cyan-400 flex items-center gap-2">
              <Workflow size={16} /> Accessories (DIN)
            </h2>
            <div className="space-y-6">
              
              {/* Shut-Off Valve */}
              <div className="space-y-3 p-3 rounded-xl bg-[#1c1c21]/50 border border-white/5">
                <div className="flex justify-between items-center">
                  <label className="text-[11px] text-gray-400 uppercase font-bold">Shut-Off Valve (DIN 16 272)</label>
                  <button onClick={() => toggleAccessory('valve')} className={`w-10 h-6 rounded-full transition-colors relative ${config.accessories.valve.enabled ? 'bg-cyan-600' : 'bg-gray-700'}`}>
                    <div className={`w-4 h-4 rounded-full bg-white absolute top-1 transition-all ${config.accessories.valve.enabled ? 'left-5' : 'left-1'}`}></div>
                  </button>
                </div>
                {config.accessories.valve.enabled && (
                  <div className="grid grid-cols-2 gap-3 animate-in fade-in slide-in-from-top-2 duration-200">
                    <div className="space-y-1">
                      <label className="text-[9px] text-gray-500 uppercase font-bold">Type</label>
                      <select value={config.accessories.valve.type} onChange={(e) => updateAccessory('valve', 'type', e.target.value)} className="w-full bg-[#0f0f11] border border-white/10 rounded-lg p-2 text-xs font-bold outline-none">
                        {valveTypes.map(t => <option key={t}>{t}</option>)}
                      </select>
                    </div>
                    <div className="space-y-1">
                      <label className="text-[9px] text-gray-500 uppercase font-bold">Material</label>
                       <select value={config.accessories.valve.material} onChange={(e) => updateAccessory('valve', 'material', e.target.value)} className="w-full bg-[#0f0f11] border border-white/10 rounded-lg p-2 text-xs font-bold outline-none">
                        {accessoryMaterials.map(m => <option key={m}>{m}</option>)}
                      </select>
                    </div>
                  </div>
                )}
              </div>

              {/* Siphon */}
              <div className="space-y-3 p-3 rounded-xl bg-[#1c1c21]/50 border border-white/5">
                <div className="flex justify-between items-center">
                  <label className="text-[11px] text-gray-400 uppercase font-bold">Siphon (DIN 16 282)</label>
                  <button onClick={() => toggleAccessory('siphon')} className={`w-10 h-6 rounded-full transition-colors relative ${config.accessories.siphon.enabled ? 'bg-cyan-600' : 'bg-gray-700'}`}>
                    <div className={`w-4 h-4 rounded-full bg-white absolute top-1 transition-all ${config.accessories.siphon.enabled ? 'left-5' : 'left-1'}`}></div>
                  </button>
                </div>
                {config.accessories.siphon.enabled && (
                  <div className="grid grid-cols-2 gap-3 animate-in fade-in slide-in-from-top-2 duration-200">
                    <div className="space-y-1">
                      <label className="text-[9px] text-gray-500 uppercase font-bold">Type</label>
                      <select value={config.accessories.siphon.type} onChange={(e) => updateAccessory('siphon', 'type', e.target.value)} className="w-full bg-[#0f0f11] border border-white/10 rounded-lg p-2 text-xs font-bold outline-none">
                        {siphonTypes.map(t => <option key={t}>{t}</option>)}
                      </select>
                    </div>
                    <div className="space-y-1">
                      <label className="text-[9px] text-gray-500 uppercase font-bold">Material</label>
                       <select value={config.accessories.siphon.material} onChange={(e) => updateAccessory('siphon', 'material', e.target.value)} className="w-full bg-[#0f0f11] border border-white/10 rounded-lg p-2 text-xs font-bold outline-none">
                        {accessoryMaterials.map(m => <option key={m}>{m}</option>)}
                      </select>
                    </div>
                  </div>
                )}
              </div>

            </div>
          </section>

          {/* Other Technical Params Section */}
          <section className="bg-[#16161a] p-6 rounded-3xl shadow-xl border border-white/5">
            <h2 className="text-xs font-black mb-4 uppercase tracking-widest text-pink-400 flex items-center gap-2">
              <ScrollText size={16} /> Other Technical Parameters
            </h2>
            <textarea
              value={config.otherTechnicalParams}
              onChange={(e) => updateConfig('otherTechnicalParams', e.target.value)}
              className="w-full h-48 bg-[#1c1c21] border border-white/5 rounded-xl p-3 outline-none focus:ring-2 focus:ring-pink-500/50 text-xs font-mono text-gray-300 resize-none leading-relaxed"
              placeholder="Enter additional technical details..."
            />
          </section>

          {/* Options */}
          <section className="bg-[#16161a] p-6 rounded-3xl shadow-xl border border-white/5">
             <h2 className="text-xs font-black mb-4 uppercase tracking-widest text-purple-400 flex items-center gap-2">
              <Settings size={16} /> Options
            </h2>
            <div className="space-y-2">
              <button onClick={() => toggleOption('redPointer')} className={`w-full flex items-center justify-between p-3 rounded-xl border text-xs font-bold transition-all ${config.options.redPointer ? 'bg-purple-600/20 border-purple-500 text-purple-300' : 'bg-[#1c1c21] border-white/5 text-gray-500'}`}>
                <span>Red Set Pointer</span>
                {config.options.redPointer ? <CheckCircle2 size={16}/> : <div className="w-4 h-4 rounded-full border border-gray-600"></div>}
              </button>
              <button onClick={() => toggleOption('oxygenService')} className={`w-full flex items-center justify-between p-3 rounded-xl border text-xs font-bold transition-all ${config.options.oxygenService ? 'bg-purple-600/20 border-purple-500 text-purple-300' : 'bg-[#1c1c21] border-white/5 text-gray-500'}`}>
                <span>Oxygen Service</span>
                {config.options.oxygenService ? <CheckCircle2 size={16}/> : <div className="w-4 h-4 rounded-full border border-gray-600"></div>}
              </button>
               <button onClick={() => toggleOption('calibrationCert')} className={`w-full flex items-center justify-between p-3 rounded-xl border text-xs font-bold transition-all ${config.options.calibrationCert ? 'bg-purple-600/20 border-purple-500 text-purple-300' : 'bg-[#1c1c21] border-white/5 text-gray-500'}`}>
                <span>Calibration Certificate</span>
                {config.options.calibrationCert ? <CheckCircle2 size={16}/> : <div className="w-4 h-4 rounded-full border border-gray-600"></div>}
              </button>
            </div>
          </section>

        </div>

        {/* Right Column: Visualization */}
        <div className="lg:col-span-7 space-y-6">
          <div id="blueprint-capture-area" ref={previewRef} className="bg-white p-6 md:p-12 rounded-[48px] shadow-2xl flex flex-col items-center justify-center min-h-[600px] md:min-h-[750px] relative overflow-hidden border border-gray-100">
            <div className="absolute top-10 left-12 text-[10px] text-gray-400 uppercase tracking-[0.4em] font-black">Industrial Configurator - Preview</div>
            
            {/* Dynamic SVG */}
            <svg width="100%" height="600" viewBox="0 0 600 600" preserveAspectRatio="xMidYMid meet">
              <defs>
                {/* Case Metallic Gradient */}
                <linearGradient id="caseGrad" x1="0" y1="0" x2="1" y2="1">
                  <stop offset="0%" stopColor="#e0e0e0" />
                  <stop offset="40%" stopColor="#f5f5f5" />
                  <stop offset="100%" stopColor="#d4d4d4" />
                </linearGradient>
                {/* Shadow for bezel */}
                <filter id="dropshadow" height="130%">
                  <feGaussianBlur in="SourceAlpha" stdDeviation="3"/> 
                  <feOffset dx="2" dy="2" result="offsetblur"/> 
                  <feComponentTransfer>
                    <feFuncA type="linear" slope="0.3"/> 
                  </feComponentTransfer>
                  <feMerge> 
                    <feMergeNode/>
                    <feMergeNode in="SourceGraphic"/> 
                  </feMerge>
                </filter>
                <clipPath id="gaugeFaceClip">
                   <circle cx="0" cy="0" r={visual.rDial} />
                </clipPath>
              </defs>

              <g transform={`translate(${visual.cx}, ${visual.cy})`}>
                
                {/* Connection Stem (Lower) */}
                {config.connection.location === 'Lower' && (
                   <g transform={`translate(0, ${visual.r})`}>
                     {/* Hex nut */}
                     <rect x={-visual.stemWidth} y="0" width={visual.stemWidth*2} height={visual.stemLen * 0.4} fill="#bbb" stroke="#777" />
                     <rect x={-visual.stemWidth * 0.8} y="0" width={visual.stemWidth*1.6} height={visual.stemLen * 0.4} fill="#ccc" />
                     {/* Thread */}
                     <rect x={-visual.stemWidth * 0.7} y={visual.stemLen * 0.4} width={visual.stemWidth*1.4} height={visual.stemLen * 0.6} fill="#bbb" stroke="#888" />
                     
                     {/* Accessories Rendering Stack */}
                     <g transform={`translate(0, ${visual.stemLen})`}>
                        
                        {/* 1. Shut-Off Valve Logic */}
                        {config.accessories.valve.enabled && (
                          <g>
                             {/* Valve Body Block */}
                             <rect x={-25 * visual.scale} y="0" width={50 * visual.scale} height={40 * visual.scale} rx="2" fill="#d4d4d4" stroke="#666" strokeWidth="1" />
                             {/* Handle (Blue/Black/Red based on material or standard) */}
                             <rect x={-40 * visual.scale} y={10 * visual.scale} width={30 * visual.scale} height={8 * visual.scale} fill="#333" rx="2" />
                             <rect x={-15 * visual.scale} y={12 * visual.scale} width={15 * visual.scale} height={4 * visual.scale} fill="#666" />
                             
                             {/* Test Connection Stub (Form A) */}
                             {config.accessories.valve.type.includes('Form A') && (
                               <g transform={`translate(${25 * visual.scale}, ${20 * visual.scale})`}>
                                 <rect x="0" y="-5" width={10} height={10} fill="#bbb" stroke="#666"/>
                               </g>
                             )}
                             
                             {/* Move coordinate system down for next item */}
                             <g transform={`translate(0, ${40 * visual.scale})`}>
                                {/* 2. Siphon Logic */}
                                {config.accessories.siphon.enabled ? (
                                   <g>
                                      {/* Connecting stub */}
                                      <rect x={-visual.stemWidth * 0.6} y="0" width={visual.stemWidth * 1.2} height={10} fill="#bbb" stroke="#777"/>
                                      
                                      {config.accessories.siphon.type.includes('Trumpet') ? (
                                        // Loop / Trumpet Form
                                        <g transform="translate(0, 10)">
                                            {/* Loop circle */}
                                            <circle cx="20" cy="20" r="20" fill="none" stroke="#666" strokeWidth="8" />
                                            {/* Inlet/Outlet pipes */}
                                            <path d="M 0 0 L 0 20 A 20 20 0 1 0 40 20 L 40 60" fill="none" stroke="#666" strokeWidth="8"/>
                                            {/* Highlight for pipe */}
                                            <path d="M 0 0 L 0 20 A 20 20 0 1 0 40 20 L 40 60" fill="none" stroke="#999" strokeWidth="3"/>
                                        </g>
                                      ) : (
                                        // U-Form
                                        <g transform="translate(0, 10)">
                                           <path d="M 0 0 L 0 40 A 20 20 0 0 0 40 40 L 40 0" fill="none" stroke="#666" strokeWidth="8" />
                                           <path d="M 0 0 L 0 40 A 20 20 0 0 0 40 40 L 40 0" fill="none" stroke="#999" strokeWidth="3" />
                                        </g>
                                      )}
                                   </g>
                                ) : (
                                  // Just output thread if no siphon
                                  <g>
                                    <rect x={-visual.stemWidth * 0.6} y="0" width={visual.stemWidth * 1.2} height={15} fill="#bbb" stroke="#777"/>
                                    <line x1={-10} y1={5} x2={10} y2={5} stroke="#888"/>
                                    <line x1={-10} y1={10} x2={10} y2={10} stroke="#888"/>
                                  </g>
                                )}
                             </g>
                          </g>
                        )}

                        {/* If NO Valve but YES Siphon, attach siphon directly to stem */}
                        {!config.accessories.valve.enabled && config.accessories.siphon.enabled && (
                           <g>
                              {config.accessories.siphon.type.includes('Trumpet') ? (
                                <g transform="translate(0, 0)">
                                    <circle cx="20" cy="20" r="20" fill="none" stroke="#666" strokeWidth="8" />
                                    <path d="M 0 0 L 0 20 A 20 20 0 1 0 40 20 L 40 60" fill="none" stroke="#666" strokeWidth="8"/>
                                    <path d="M 0 0 L 0 20 A 20 20 0 1 0 40 20 L 40 60" fill="none" stroke="#999" strokeWidth="3"/>
                                </g>
                              ) : (
                                <g transform="translate(0, 0)">
                                   <path d="M 0 0 L 0 40 A 20 20 0 0 0 40 40 L 40 0" fill="none" stroke="#666" strokeWidth="8" />
                                   <path d="M 0 0 L 0 40 A 20 20 0 0 0 40 40 L 40 0" fill="none" stroke="#999" strokeWidth="3" />
                                </g>
                              )}
                           </g>
                        )}
                     </g>

                     {/* Thread lines on main stem only if no accessories covering it, but stem already drawn above */}
                   </g>
                )}

                {/* Mounting: Rear Flange (Surface) - Drawn BEHIND case */}
                {config.options.flange.includes('Rear') && (
                  <circle r={visual.r + 15} fill="#d0d0d0" stroke="#999" strokeWidth="1" />
                )}
                {/* Mounting: Front Flange (Panel) - Drawn BEHIND case for rim effect */}
                {config.options.flange.includes('Front') && (
                  <circle r={visual.r + 20} fill="#d8d8d8" stroke="#999" strokeWidth="1" />
                )}

                {/* Main Case Body */}
                <circle r={visual.r} fill="url(#caseGrad)" stroke="#999" strokeWidth="1" filter="url(#dropshadow)" />
                
                {/* Mounting: Front Flange Holes - Drawn ON TOP of case rim */}
                {config.options.flange.includes('Front') && (
                  <g>
                    {[0, 120, 240].map(angle => (
                      <g key={angle} transform={`rotate(${angle}) translate(0, -${visual.r + 12})`}>
                        <circle r="3" fill="#333" />
                        <circle r="1.5" fill="#fff" opacity="0.3" />
                      </g>
                    ))}
                  </g>
                )}
                
                {/* Bezel Ring */}
                <circle r={visual.rInner} fill="none" stroke="#b0b0b0" strokeWidth="4" />
                
                {/* Dial Face (White) */}
                <circle r={visual.rDial} fill="#fff" />

                {/* Liquid Filling Simulation */}
                {config.case.filling !== 'Dry' && (
                  <g clipPath="url(#gaugeFaceClip)">
                    {/* Liquid level with bubble at top */}
                    <path 
                      d={`M -${visual.rDial} -${visual.rDial*0.6} 
                          Q 0 -${visual.rDial*0.5} ${visual.rDial} -${visual.rDial*0.6} 
                          L ${visual.rDial} ${visual.rDial} 
                          L -${visual.rDial} ${visual.rDial} Z`} 
                      fill={config.case.filling.includes('Silicone') ? "rgba(200, 200, 250, 0.2)" : "rgba(200, 255, 230, 0.3)"}
                    />
                    <path 
                      d={`M -${visual.rDial} -${visual.rDial*0.6} Q 0 -${visual.rDial*0.5} ${visual.rDial} -${visual.rDial*0.6}`}
                      stroke={config.case.filling.includes('Silicone') ? "rgba(100, 100, 200, 0.2)" : "rgba(100, 200, 150, 0.3)"}
                      fill="none"
                      strokeWidth="1"
                    />
                  </g>
                )}

                {/* Scale Ticks & Numbers */}
                <ScaleTicks r={visual.rDial} min={config.rangeMin} max={config.rangeMax} />

                {/* Labels */}
                <text y={visual.rDial * 0.35} textAnchor="middle" className="font-black text-xs md:text-sm tracking-widest fill-gray-800">DIN</text>
                <text y={visual.rDial * 0.5} textAnchor="middle" className="font-bold text-xs fill-gray-600">{config.unit}</text>
                <text y={visual.rDial * 0.65} textAnchor="middle" className="font-bold text-[8px] fill-gray-400">316L</text>
                
                {/* Tag Number on Dial */}
                {config.project.tagNumber && (
                   <rect x={-visual.rDial * 0.3} y={visual.rDial * 0.1} width={visual.rDial * 0.6} height={16} fill="rgba(255,255,255,0.8)" rx="2" />
                )}
                {config.project.tagNumber && (
                  <text y={visual.rDial * 0.1 + 11} textAnchor="middle" className="font-mono font-bold text-[10px] fill-black uppercase tracking-tight">
                    {config.project.tagNumber}
                  </text>
                )}
                
                {/* Safety Glass Symbol */}
                {config.case.window.includes('safety') && (
                   <g transform={`translate(0, ${-visual.rDial * 0.5}) scale(0.6)`}>
                     <path d="M -10 0 L 0 -10 L 10 0 L 0 10 Z" fill="none" stroke="#000" strokeWidth="1.5" />
                     <line x1="-5" y1="0" x2="5" y2="0" stroke="#000" strokeWidth="1.5" />
                     <line x1="0" y1="-5" x2="0" y2="5" stroke="#000" strokeWidth="1.5" />
                   </g>
                )}

                {/* Red Set Pointer (Optional) */}
                {config.options.redPointer && (
                  <g transform="rotate(120)">
                    <polygon points="0,-10 4,-90 0,-95 -4,-90" fill="red" opacity="0.9" />
                  </g>
                )}

                {/* Main Pointer (Black) - Static at approx 60% scale for demo */}
                <g transform="rotate(-30)" filter="url(#dropshadow)">
                   {/* Center Hub */}
                   <circle r="5" fill="#000" />
                   {/* Needle */}
                   <path d={`M -2 0 L -1 -${visual.rDial * 0.85} L 1 -${visual.rDial * 0.85} L 2 0 Z`} fill="#000" />
                   {/* Counterweight */}
                   <path d="M -3 0 L -4 15 L 4 15 L 3 0 Z" fill="#000" />
                </g>

                {/* Central pin cap */}
                <circle r="2" fill="#888" />

              </g>

              {/* Back Mount Representation (Ghosted behind if selected) */}
              {config.connection.location === 'Back' && (
                <text x="500" y="550" textAnchor="end" className="text-sm fill-gray-400 font-mono">
                  * BACK CONNECTION VIEW
                </text>
              )}
            </svg>

            <div className="absolute bottom-10 right-12 flex items-center gap-2 text-orange-500/40 font-black text-[10px] pointer-events-none">
              <ExternalLink size={12} /> cadautoscript.com
            </div>
            
            <div className="absolute bottom-10 left-12 flex flex-col gap-1 text-gray-300 font-mono text-[10px]">
               <div>NS: {config.nominalSize}mm</div>
               <div>RANGE: {config.rangeMin}..{config.rangeMax} {config.unit}</div>
               <div>CONN: {config.connection.location.toUpperCase()}</div>
               {config.project.tagNumber && <div className="text-orange-400">TAG: {config.project.tagNumber}</div>}
               {config.accessories.valve.enabled && <div className="text-cyan-400">+ VALVE {config.accessories.valve.standard}</div>}
               {config.accessories.siphon.enabled && <div className="text-cyan-400">+ SIPHON {config.accessories.siphon.standard}</div>}
            </div>
          </div>
        </div>
      </div>

      <style>{`
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #444; }
      `}</style>
    </div>
  );
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
  </script>
</body>

</html>
