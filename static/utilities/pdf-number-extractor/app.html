<!DOCTYPE html>
<html lang="en" class="dark">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PDF Number Extractor</title>

  <script src="../../vendor/pdf.min.js"></script>
  <script>
    if (window.pdfjsLib) {
      pdfjsLib.GlobalWorkerOptions.workerSrc = "../../vendor/pdf.worker.min.js";
    }
  </script>

  <script src="../../vendor/jspdf.umd.min.js"></script>

  <script src="../../vendor/tailwindcss.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            // MD3 inspired dark palette (Zinc based)
            surface: '#141218',
            'surface-container': '#1D1B20',
            'surface-container-high': '#2B2930',
            primary: '#D0BCFF', // MD3 Light Purple for Dark mode
            'on-primary': '#381E72',
            secondary: '#CCC2DC',
            'on-secondary': '#332D41',
            tertiary: '#EFB8C8',
            error: '#F2B8B5',
            outline: '#938F99'
          }
        }
      }
    };
  </script>

  <!-- <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet"/> -->

  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #141218;
      color: #E6E1E5;
    }

    /* Custom Scrollbar for Dark Mode */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #1D1B20;
    }

    ::-webkit-scrollbar-thumb {
      background: #49454F;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #938F99;
    }

    /* Loader */
    .loader {
      border: 4px solid #49454F;
      border-top: 4px solid #D0BCFF;
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
    }

    .mini-loader {
      width: 16px;
      height: 16px;
      border: 2px solid #49454F;
      border-top: 2px solid #D0BCFF;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Screenshot Preview */
    #capture-preview {
      position: relative;
      border: 2px dashed #938F99;
      background: #2B2930;
      transition: all .2s;
      --pos-x: 30%;
      --pos-y: 50%;
    }

    #capture-preview::before,
    #capture-preview::after {
      content: '';
      position: absolute;
      background: #F2B8B5;
    }

    #capture-preview::before {
      left: var(--pos-x);
      top: 0;
      width: 1px;
      height: 100%;
    }

    #capture-preview::after {
      top: var(--pos-y);
      left: 0;
      width: 100%;
      height: 1px;
    }

    #capture-preview-text {
      position: absolute;
      top: var(--pos-y);
      left: var(--pos-x);
      transform: translate(-50%, -50%);
      font-size: 10px;
      color: #601410;
      background: #F2B8B5;
      padding: 1px 3px;
      border-radius: 2px;
      white-space: nowrap;
      font-weight: bold;
    }

    /* Range Slider Styling */
    input[type=range] {
      -webkit-appearance: none;
      width: 100%;
      background: transparent;
    }

    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 16px;
      width: 16px;
      border-radius: 50%;
      background: #D0BCFF;
      cursor: pointer;
      margin-top: -6px;
    }

    input[type=range]::-webkit-slider-runnable-track {
      width: 100%;
      height: 4px;
      background: #49454F;
      border-radius: 2px;
    }

    .result-item.excluded {
      opacity: 0.4;
    }

    .result-item:hover .exclude-btn {
      opacity: 1;
    }

    #file-drop-container.has-files {
      padding: 1rem;
      align-items: flex-start;
    }

    #file-drop-container.no-files {
      padding: 2rem;
      align-items: center;
    }
  </style>
</head>

<body class="antialiased selection:bg-primary selection:text-on-primary">

  <div class="container mx-auto p-4 sm:p-6 max-w-5xl">

    <header class="flex justify-between items-center mb-8 pb-4 border-b border-white/10">
      <div>
        <h1 class="text-3xl font-bold tracking-tight text-primary">PDF Number Extractor</h1>
        <p class="text-sm text-gray-400 mt-1">Extract prefixed numbers up to a specified length</p>
      </div>
      <button id="help-btn"
        class="p-3 rounded-full bg-surface-container-high hover:bg-[#36343b] transition-colors text-white"
        aria-label="Open help">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </button>
    </header>

    <main class="bg-surface-container rounded-3xl shadow-xl p-6 sm:p-8">

      <div id="main-section">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
          <h2 class="text-xl font-medium text-white">1. Files & Configuration</h2>
          <div class="flex gap-2">
            <button id="add-files-btn"
              class="text-sm bg-primary text-on-primary font-medium py-2 px-4 rounded-full hover:brightness-110 transition-all shadow-sm">
              + Add Files
            </button>
            <button id="clear-files-btn"
              class="text-sm bg-surface-container-high border border-outline/30 text-secondary font-medium py-2 px-4 rounded-full hover:bg-[#36343b] disabled:opacity-50 transition-all"
              disabled>
              Clear List
            </button>
          </div>
        </div>

        <div id="file-drop-container"
          class="mb-8 border-2 border-dashed border-outline/40 rounded-2xl bg-surface-container-high/50 text-center cursor-pointer hover:border-primary hover:bg-surface-container-high transition-all flex flex-col justify-center min-h-[160px]">
          <input type="file" id="pdf-upload" accept="application/pdf" class="hidden" multiple>
          <div id="file-list-content" class="w-full text-left max-h-60 overflow-y-auto custom-scrollbar pr-2"></div>
        </div>

        <hr class="border-white/10 mb-8" />

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">

          <div class="space-y-6">
            <h3 class="text-lg font-medium text-secondary">Extraction Rules</h3>

            <div class="flex gap-4">
              <div class="w-1/2">
                <label for="prefix-input"
                  class="block text-xs font-medium text-gray-400 mb-1 ml-1 uppercase tracking-wider">Prefix</label>
                <input type="text" id="prefix-input" value="W" maxlength="5"
                  class="w-full bg-surface-container-high text-white text-center border border-outline/30 rounded-xl p-3 focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all">
              </div>
              <div class="w-1/2">
                <label for="length-input"
                  class="block text-xs font-medium text-gray-400 mb-1 ml-1 uppercase tracking-wider">Max Length</label>
                <input type="number" id="length-input" value="6" min="1"
                  class="w-full bg-surface-container-high text-white text-center border border-outline/30 rounded-xl p-3 focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all">
              </div>
            </div>

            <div class="space-y-3 bg-surface-container-high/30 p-4 rounded-xl border border-white/5">
              <label class="flex items-center cursor-pointer group">
                <input type="checkbox" id="filter-revisions-checkbox"
                  class="h-5 w-5 rounded border-outline/50 bg-surface-container-high text-primary focus:ring-primary/50">
                <span class="ml-3 text-sm text-gray-300 group-hover:text-white transition-colors">Process only latest
                  revision (_rXX_)</span>
              </label>
              <label class="flex items-center cursor-pointer group">
                <input type="checkbox" id="include-revision-checkbox"
                  class="h-5 w-5 rounded border-outline/50 bg-surface-container-high text-primary focus:ring-primary/50">
                <span class="ml-3 text-sm text-gray-300 group-hover:text-white transition-colors">Include revision in
                  reports</span>
              </label>
              <label class="flex items-center cursor-pointer group">
                <input type="checkbox" id="filter-csv-duplicates-checkbox"
                  class="h-5 w-5 rounded border-outline/50 bg-surface-container-high text-primary focus:ring-primary/50">
                <span class="ml-3 text-sm text-gray-300 group-hover:text-white transition-colors">Remove duplicates in
                  CSV (keep longest)</span>
              </label>
              <label class="flex items-center cursor-pointer group">
                <input type="checkbox" id="prefill-comments-checkbox" checked
                  class="h-5 w-5 rounded border-outline/50 bg-surface-container-high text-primary focus:ring-primary/50">
                <span class="ml-3 text-sm text-gray-300 group-hover:text-white transition-colors">Prefill Comments with
                  drawing name</span>
              </label>
            </div>
          </div>

          <div class="space-y-6">
            <h3 class="text-lg font-medium text-secondary">Screenshot Settings</h3>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-medium text-gray-400 mb-1 ml-1">Width (px)</label>
                <input type="number" id="capture-width" value="400" step="10"
                  class="w-full bg-surface-container-high text-white border border-outline/30 rounded-xl p-2 px-3 text-sm focus:ring-2 focus:ring-primary outline-none">
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-400 mb-1 ml-1">Height (px)</label>
                <input type="number" id="capture-height" value="175" step="10"
                  class="w-full bg-surface-container-high text-white border border-outline/30 rounded-xl p-2 px-3 text-sm focus:ring-2 focus:ring-primary outline-none">
              </div>
            </div>

            <div class="space-y-4">
              <div>
                <div class="flex justify-between mb-1">
                  <span class="text-xs text-gray-400">Horizontal (X)</span>
                  <span class="text-xs text-primary font-mono" id="position-x-label">30</span>
                </div>
                <input type="range" id="position-x" min="0" max="100" value="30">
              </div>
              <div>
                <div class="flex justify-between mb-1">
                  <span class="text-xs text-gray-400">Vertical (Y)</span>
                  <span class="text-xs text-primary font-mono" id="position-y-label">50</span>
                </div>
                <input type="range" id="position-y" min="0" max="100" value="50">
              </div>
            </div>

            <div class="flex justify-center mt-2">
              <div id="capture-preview" class="shadow-lg rounded-md overflow-hidden">
                <div id="capture-preview-text">12345</div>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-10 flex justify-end">
          <button id="run-analysis-btn"
            class="bg-primary text-on-primary font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-primary/20 hover:brightness-110 transition-all text-lg flex items-center gap-2">
            <span>Run Analysis</span>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
              stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z" />
            </svg>
          </button>
        </div>
      </div>

      <div id="processing-section" class="hidden text-center py-16">
        <div class="loader mx-auto mb-6"></div>
        <h3 class="text-xl font-medium text-white">Analyzing Documents</h3>
        <p id="status" class="mt-2 text-gray-400">Initializing...</p>
      </div>

      <div id="results-section" class="hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-medium text-white">2. Results & Export</h2>
          <button id="back-to-main-btn"
            class="text-sm text-secondary hover:text-white flex items-center gap-1 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
              stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
            </svg>
            Back to Config
          </button>
        </div>

        <div class="bg-surface-container-high/30 rounded-2xl p-4 mb-6 border border-white/5 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
            stroke="currentColor" class="w-6 h-6 text-primary mr-3">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p id="result-summary" class="text-gray-300 font-medium"></p>
        </div>

        <div id="image-results-header"
          class="hidden md:flex items-center px-4 pb-2 border-b border-white/10 text-sm text-gray-500 uppercase tracking-wider font-semibold">
          <div class="w-1/3 pl-2">Preview</div>
          <div class="w-2/3 pl-4">Comments</div>
        </div>

        <div id="image-results" class="space-y-4 mt-4 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2"></div>

        <div class="mt-8 pt-6 border-t border-white/10">
          <h3 class="text-center text-sm text-gray-500 uppercase tracking-wider font-semibold mb-4">Export Options</h3>
          <div class="flex flex-wrap justify-center gap-4">
            <button id="generate-report"
              class="bg-blue-600 text-white font-medium py-3 px-6 rounded-full shadow-lg hover:bg-blue-500 transition-all flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
              PDF Report
            </button>
            <button id="export-txt"
              class="bg-emerald-700 text-white font-medium py-3 px-6 rounded-full shadow-lg hover:bg-emerald-600 transition-all flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              TXT List
            </button>
            <button id="export-csv"
              class="bg-amber-700 text-white font-medium py-3 px-6 rounded-full shadow-lg hover:bg-amber-600 transition-all flex items-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
              CSV Data
            </button>
          </div>
        </div>
      </div>
    </main>

    <footer class="text-center mt-12 text-sm text-gray-600">
      <p>PDF Number Extractor v0.35.0 (Dark)</p>
    </footer>
  </div>

  <div id="pdf-viewer-modal"
    class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 z-50">
    <div
      class="bg-surface-container rounded-2xl shadow-2xl w-full h-full md:h-[90vh] md:w-[90vw] flex flex-col border border-white/10">
      <div
        class="p-4 border-b border-white/10 flex justify-between items-center bg-surface-container-high rounded-t-2xl">
        <h3 id="pdf-viewer-title" class="text-lg font-medium text-white truncate px-2">PDF Viewer</h3>
        <button id="close-viewer-btn"
          class="text-gray-400 hover:text-white p-2 rounded-full hover:bg-white/10 transition-colors"
          aria-label="Close viewer">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"
            class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <iframe id="pdf-viewer-iframe" class="w-full flex-grow rounded-b-2xl bg-white/5"></iframe>
    </div>
  </div>

  <div id="help-modal"
    class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50">
    <div
      class="bg-surface-container rounded-3xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[90vh] border border-white/10">
      <div class="p-6 border-b border-white/10 flex justify-between items-center">
        <h3 class="text-xl font-bold text-white">Help & Instructions</h3>
        <button id="close-help-btn"
          class="text-gray-400 hover:text-white p-2 rounded-full hover:bg-white/10 transition-colors"
          aria-label="Close help">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"
            class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div id="help-modal-content" class="p-8 overflow-y-auto space-y-6 text-gray-300 leading-relaxed">
        <div class="space-y-2">
          <h4 class="text-lg font-bold text-primary">1. Adding Files</h4>
          <p>Click "Add Files" or drag and drop PDF files into the dashed area. Filenames are clickable to preview.
            Files are processed locally in your browser.</p>
        </div>
        <div class="space-y-2">
          <h4 class="text-lg font-bold text-primary">2. Configuration</h4>
          <p>Set the <strong>Prefix</strong> (e.g., 'W') and <strong>Max Length</strong> (e.g., 6) for the numbers you
            want to extract.</p>
          <ul class="list-disc pl-5 space-y-1 text-sm text-gray-400">
            <li><strong>Latest revision:</strong> Filters files to keep only the highest revision number found in
              filenames.</li>
            <li><strong>Duplicates in CSV:</strong> If checked, multiple findings of the same number are removed,
              keeping the one with the longest text string.</li>
          </ul>
        </div>
        <div class="space-y-2">
          <h4 class="text-lg font-bold text-primary">3. Screenshot Tweaking</h4>
          <p>Adjust the width, height, and relative position (X/Y) to ensure the extracted number is centered in the
            generated screenshots.</p>
        </div>
        <div class="space-y-2">
          <h4 class="text-lg font-bold text-primary">4. Export</h4>
          <p>Run the analysis, review matches, exclude false positives, then export to PDF, TXT, or CSV.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- DOM refs ---
    const mainSection = document.getElementById('main-section');
    const fileDropContainer = document.getElementById('file-drop-container');
    const fileListContent = document.getElementById('file-list-content');
    const processingSection = document.getElementById('processing-section');
    const resultsSection = document.getElementById('results-section');
    const pdfUpload = document.getElementById('pdf-upload');
    const statusDisplay = document.getElementById('status');
    const resultSummary = document.getElementById('result-summary');
    const imageResults = document.getElementById('image-results');
    const imageResultsHeader = document.getElementById('image-results-header');
    const generateReportBtn = document.getElementById('generate-report');
    const exportTxtBtn = document.getElementById('export-txt');
    const exportCsvBtn = document.getElementById('export-csv');
    const filterRevisionsCheckbox = document.getElementById('filter-revisions-checkbox');
    const includeRevisionCheckbox = document.getElementById('include-revision-checkbox');
    const filterCsvDuplicatesCheckbox = document.getElementById('filter-csv-duplicates-checkbox');
    const prefillCommentsCheckbox = document.getElementById('prefill-comments-checkbox');
    const runAnalysisBtn = document.getElementById('run-analysis-btn');
    const clearFilesBtn = document.getElementById('clear-files-btn');
    const addFilesBtn = document.getElementById('add-files-btn');
    const backToMainBtn = document.getElementById('back-to-main-btn');
    const prefixInput = document.getElementById('prefix-input');
    const lengthInput = document.getElementById('length-input');
    const captureWidthInput = document.getElementById('capture-width');
    const captureHeightInput = document.getElementById('capture-height');
    const capturePreview = document.getElementById('capture-preview');
    const positionXInput = document.getElementById('position-x');
    const positionYInput = document.getElementById('position-y');
    const positionXLabel = document.getElementById('position-x-label');
    const positionYLabel = document.getElementById('position-y-label');
    const pdfViewerModal = document.getElementById('pdf-viewer-modal');
    const pdfViewerTitle = document.getElementById('pdf-viewer-title');
    const pdfViewerIframe = document.getElementById('pdf-viewer-iframe');
    const closeViewerBtn = document.getElementById('close-viewer-btn');
    const helpBtn = document.getElementById('help-btn');
    const helpModal = document.getElementById('help-modal');
    const closeHelpBtn = document.getElementById('close-help-btn');

    let capturedImages = [];
    let allUploadedFiles = [];
    let currentViewerObjectUrl = null;

    // --- Events ---
    fileDropContainer.addEventListener('click', () => { if (allUploadedFiles.length === 0) pdfUpload.click(); });
    fileDropContainer.addEventListener('dragover', e => { e.preventDefault(); fileDropContainer.classList.add("border-primary", "bg-surface-container-high"); });
    fileDropContainer.addEventListener('dragleave', () => fileDropContainer.classList.remove("border-primary", "bg-surface-container-high"));
    fileDropContainer.addEventListener('drop', e => { e.preventDefault(); fileDropContainer.classList.remove("border-primary", "bg-surface-container-high"); if (e.dataTransfer.files.length > 0) handleFiles(e.dataTransfer.files); });
    pdfUpload.addEventListener('change', e => { if (e.target.files.length > 0) handleFiles(e.target.files); });
    filterRevisionsCheckbox.addEventListener('change', renderFileList);
    runAnalysisBtn.addEventListener('click', runAnalysis);
    clearFilesBtn.addEventListener('click', clearFileListUI);
    addFilesBtn.addEventListener('click', () => pdfUpload.click());
    backToMainBtn.addEventListener('click', () => { resultsSection.classList.add('hidden'); mainSection.classList.remove('hidden'); });
    captureWidthInput.addEventListener('input', updateCapturePreview);
    captureHeightInput.addEventListener('input', updateCapturePreview);
    positionXInput.addEventListener('input', updateCapturePreview);
    positionYInput.addEventListener('input', updateCapturePreview);
    closeViewerBtn.addEventListener('click', closePdfViewer);
    helpBtn.addEventListener('click', openHelpModal);
    closeHelpBtn.addEventListener('click', closeHelpModal);
    helpModal.addEventListener('click', (e) => { if (e.target === helpModal) closeHelpModal(); });

    // --- Helpers ---
    function getPrefix() { return prefixInput.value || 'W'; }

    function getSearchRegex(isGlobal = false) {
      const escapedPrefix = getPrefix().replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
      const pattern = `${escapedPrefix}(\\d+)`;
      return new RegExp(pattern, isGlobal ? 'g' : '');
    }

    function getBaseNumberRegex() {
      const escapedPrefix = getPrefix().replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
      return new RegExp(`${escapedPrefix}\\d+`);
    }

    function updateCapturePreview() {
      const width = parseInt(captureWidthInput.value) || 400;
      const height = parseInt(captureHeightInput.value) || 175;
      const posX = positionXInput.value, posY = positionYInput.value;
      const previewScale = 0.25;
      capturePreview.style.width = `${Math.max(20, width * previewScale)}px`;
      capturePreview.style.height = `${Math.max(20, height * previewScale)}px`;
      capturePreview.style.setProperty('--pos-x', `${posX}%`);
      capturePreview.style.setProperty('--pos-y', `${posY}%`);
      positionXLabel.textContent = posX; positionYLabel.textContent = posY;
    }

    function openPdfViewer(file, pageNumber = null, searchText = null) {
      if (currentViewerObjectUrl) { URL.revokeObjectURL(currentViewerObjectUrl); currentViewerObjectUrl = null; }
      currentViewerObjectUrl = URL.createObjectURL(file);
      const parts = []; if (pageNumber) parts.push(`page=${pageNumber}`); if (searchText) parts.push(`search=${encodeURIComponent(searchText)}`);
      pdfViewerIframe.src = currentViewerObjectUrl + (parts.length ? `#${parts.join('&')}` : '');
      pdfViewerTitle.textContent = file.name;
      pdfViewerModal.classList.remove('hidden');
    }
    function closePdfViewer() {
      pdfViewerModal.classList.add('hidden');
      pdfViewerIframe.src = '';
      if (currentViewerObjectUrl) { URL.revokeObjectURL(currentViewerObjectUrl); currentViewerObjectUrl = null; }
    }
    function openHelpModal() { helpModal.classList.remove('hidden'); }
    function closeHelpModal() { helpModal.classList.add('hidden'); }

    // --- Files handling ---
    async function handleFiles(files) {
      const newFileObjects = [...files]
        .filter(file => ((file.type === "application/pdf") || /\.pdf$/i.test(file.name)) && !allUploadedFiles.some(f => f.name === file.name))
        .map(file => ({ file, name: file.name, scanResult: 'scanning' }));
      if (newFileObjects.length === 0) return;
      allUploadedFiles.push(...newFileObjects);
      renderFileList();
      for (const fileObj of newFileObjects) {
        fileObj.scanResult = await quickScanFile(fileObj.file);
        renderFileList();
      }
    }

    async function quickScanFile(file) {
      const searchRegexGlobal = getSearchRegex(true);
      const baseNumberRegex = getBaseNumberRegex();
      const maxLength = parseInt(lengthInput.value, 10) || 6;
      let matches = [];
      try {
        const data = new Uint8Array(await file.arrayBuffer());
        const pdf = await pdfjsLib.getDocument({ data }).promise;
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();

          for (const item of textContent.items) {
            let match;
            searchRegexGlobal.lastIndex = 0;
            while ((match = searchRegexGlobal.exec(item.str)) !== null) {
              if (match[1].length <= maxLength) {
                matches.push(match[0]);
              }
            }
          }
        }
        const filePrefix = file.name.toUpperCase().startsWith('EST-') ? file.name.substring(4, 10) : file.name.substring(0, 10);
        const uniqueNumbers = new Set(matches.map(text => {
          const baseNumber = (text.match(baseNumberRegex) || [text])[0];
          return `${filePrefix}${baseNumber}`;
        }));
        return { total: matches.length, unique: uniqueNumbers.size, matches: matches };
      } catch (err) {
        console.error(`Quick scan error for ${file.name}:`, err);
        return { total: 'Error', unique: '' };
      }
    }

    function getFilesToProcess() {
      const files = allUploadedFiles.map(obj => obj.file);
      if (!filterRevisionsCheckbox.checked) return files;
      const fileGroups = {};
      const revisionRegex = /(.+?)(?:_r?(\d+))(.*)$/i;
      files.forEach(file => {
        const m = file.name.match(revisionRegex);
        let baseName, rev;
        if (m) { baseName = (m[1] || '') + (m[3] || ''); rev = parseInt(m[2], 10); }
        else { baseName = file.name; rev = -1; }
        if (!fileGroups[baseName] || rev > fileGroups[baseName].revisionNumber) fileGroups[baseName] = { file, revisionNumber: rev };
      });
      return Object.values(fileGroups).map(g => g.file);
    }

    function renderFileList() {
      const filesToProcess = getFilesToProcess();
      const names = new Set(filesToProcess.map(f => f.name));

      if (allUploadedFiles.length === 0) {
        fileDropContainer.classList.remove('has-files'); fileDropContainer.classList.add('no-files');
        fileListContent.innerHTML = `
        <div class="text-center">
          <p class="mt-2 text-sm text-gray-400">
            <span class="font-medium text-primary">Click to upload</span>
            <span>or drag and drop</span>
          </p>
          <p class="text-xs text-gray-500">PDF files only</p>
        </div>`;
        clearFilesBtn.disabled = true; return;
      }

      fileDropContainer.classList.add('has-files'); fileDropContainer.classList.remove('no-files');
      clearFilesBtn.disabled = false; fileListContent.innerHTML = '';

      allUploadedFiles.forEach((fileObj, index) => {
        const isIncluded = names.has(fileObj.name);
        const item = document.createElement('div');
        item.id = `file-item-${index}`;
        item.className = `p-3 mb-2 rounded-xl flex justify-between items-center bg-surface-container border border-white/5 ${isIncluded ? '' : 'opacity-40'}`;

        const nameSpan = document.createElement('span');
        nameSpan.textContent = fileObj.name;
        nameSpan.className = 'cursor-pointer text-primary hover:underline truncate text-sm font-medium';
        if (!isIncluded) nameSpan.classList.add('line-through');
        nameSpan.onclick = () => openPdfViewer(fileObj.file);

        const right = document.createElement('div'); right.className = 'flex items-center gap-4 flex-shrink-0 ml-4';
        const resultSpan = document.createElement('span'); resultSpan.className = 'text-xs text-gray-400';

        if (fileObj.scanResult === 'scanning') {
          resultSpan.innerHTML = `<div class="mini-loader"></div>`;
        } else if (fileObj.scanResult && typeof fileObj.scanResult === 'object') {
          if (fileObj.scanResult.total === 'Error') {
            resultSpan.textContent = 'Error';
            resultSpan.className += ' text-error';
          } else {
            resultSpan.textContent = `Found ${fileObj.scanResult.total} (${fileObj.scanResult.unique} unique)`;
            if (fileObj.scanResult.total > 0) {
              resultSpan.classList.add('cursor-pointer', 'hover:text-primary', 'transition-colors');
              resultSpan.onclick = () => generateSingleFileCsv(fileObj);
            }
          }
        }

        const delBtn = document.createElement('button');
        delBtn.innerHTML = '&times;';
        delBtn.className = 'text-gray-500 hover:text-error font-bold text-xl px-2 transition-colors';
        delBtn.onclick = () => { allUploadedFiles.splice(index, 1); renderFileList(); };

        const wrap = document.createElement('div'); wrap.className = 'flex items-center min-w-0'; wrap.appendChild(nameSpan);
        right.appendChild(resultSpan); right.appendChild(delBtn);
        item.appendChild(wrap); item.appendChild(right);
        fileListContent.appendChild(item);
      });
    }

    function clearFileListUI() { allUploadedFiles = []; pdfUpload.value = ''; renderFileList(); }

    // --- Analysis ---
    function runAnalysis() {
      const filesToProcess = getFilesToProcess();
      if (filesToProcess.length === 0) {
        alert('No files to process.');
        return;
      }
      mainSection.classList.add('hidden'); processingSection.classList.remove('hidden');
      processFiles(filesToProcess);
    }

    function isCanvasBlank(canvas) {
      if (!canvas || canvas.width === 0 || canvas.height === 0) return true;
      const ctx = canvas.getContext('2d');
      const buf = new Uint32Array(ctx.getImageData(0, 0, canvas.width, canvas.height).data.buffer);
      return buf.every(c => c === buf[0]);
    }

    async function processFiles(files) {
      capturedImages = []; imageResults.innerHTML = '';

      for (const file of files) {
        try {
          const filePrefix = file.name.toUpperCase().startsWith('EST-') ? file.name.substring(4, 10) : file.name.substring(0, 10);
          const revMatch = file.name.match(/_r?(\d+)/i);
          const revision = revMatch ? `r${revMatch[1]}` : null;

          const data = new Uint8Array(await file.arrayBuffer());
          const pdf = await pdfjsLib.getDocument({ data }).promise;

          for (let i = 1; i <= pdf.numPages; i++) {
            statusDisplay.textContent = `Analyzing ${file.name} (page ${i} of ${pdf.numPages})...`;
            const page = await pdf.getPage(i);
            await analyzePage(page, i, filePrefix, revision, file);
          }
        } catch (err) {
          console.error(`Error processing ${file.name}:`, err);
          statusDisplay.textContent = `Error with file ${file.name}. Skipping.`;
          await new Promise(res => setTimeout(res, 2000));
        }
      }
      processingSection.classList.add('hidden'); resultsSection.classList.remove('hidden');
      displayResults();
    }

    async function analyzePage(page, pageNum, filePrefix, revision, sourceFile) {
      const textContent = await page.getTextContent();
      const searchRegexGlobal = getSearchRegex(true);
      const maxLength = parseInt(lengthInput.value, 10) || 6;

      const potential = [];
      for (const item of textContent.items) {
        let match;
        searchRegexGlobal.lastIndex = 0;
        while ((match = searchRegexGlobal.exec(item.str)) !== null) {
          if (match[1].length <= maxLength) {
            const newItem = { ...item };
            newItem.str = match[0];
            potential.push(newItem);
          }
        }
      }

      if (potential.length === 0) return;

      const originalViewport = page.getViewport({ scale: 1.0 });
      const GRID_COLS = 10, GRID_ROWS = 10;
      const cellWidth = originalViewport.width / GRID_COLS;
      const cellHeight = originalViewport.height / GRID_ROWS;

      const scale = 3.0;
      const viewport = page.getViewport({ scale });
      const canvas = document.createElement('canvas');
      canvas.width = viewport.width; canvas.height = viewport.height;
      const ctx = canvas.getContext('2d');
      await page.render({ canvasContext: ctx, viewport }).promise;

      const captureWidth = parseInt(captureWidthInput.value) || 400;
      const captureHeight = parseInt(captureHeightInput.value) || 175;
      const posX = parseInt(positionXInput.value) || 30;
      const posY = parseInt(positionYInput.value) || 50;

      for (const item of potential) {
        const textX = item.transform[4], textY = item.transform[5];
        if (textX < 0 || textX > originalViewport.width || textY < 0 || textY > originalViewport.height) continue;

        const colIndex = Math.min(GRID_COLS - 1, Math.floor(textX / cellWidth));
        const rowIndex = Math.min(GRID_ROWS - 1, Math.floor((originalViewport.height - textY) / cellHeight));
        const gridCoord = `${String.fromCharCode('A'.charCodeAt(0) + colIndex)}${rowIndex + 1}`;

        const tr = pdfjsLib.Util.transform(viewport.transform, item.transform);
        const canvasX = tr[4], canvasY = tr[5];
        const sx = canvasX - (captureWidth * (posX / 100));
        const sy = canvasY - (captureHeight * (posY / 100));

        const shot = document.createElement('canvas');
        shot.width = captureWidth; shot.height = captureHeight;
        shot.getContext('2d').drawImage(canvas, sx, sy, captureWidth, captureHeight, 0, 0, captureWidth, captureHeight);
        if (isCanvasBlank(shot)) continue;

        const defaultDrawingName = sourceFile.name.replace(/\.pdf$/i, '');
        capturedImages.push({
          dataUrl: shot.toDataURL('image/png'),
          text: item.str,
          page: pageNum,
          gridCoord,
          filePrefix,
          revision,
          sourceFile,
          excluded: false,
          comment: prefillCommentsCheckbox.checked ? defaultDrawingName : ''
        });
      }
    }

    // --- Results & Export ---
    function updateResultSummary() {
      const active = capturedImages.filter(img => !img.excluded);
      if (capturedImages.length === 0) { resultSummary.textContent = "No matches found."; return; }
      const unique = new Set(active.map(img => {
        const base = (img.text.match(getBaseNumberRegex()) || [img.text])[0];
        return `${img.filePrefix}${base}`;
      }));
      resultSummary.textContent = `Found ${active.length} matches (${unique.size} unique). Review results below.`;
    }

    function toggleExclude(index, el) { capturedImages[index].excluded = !capturedImages[index].excluded; el.classList.toggle('excluded'); updateResultSummary(); }

    function displayResults() {
      const baseNumberRegex = getBaseNumberRegex();
      const sortRegex = getSearchRegex(false);
      capturedImages.sort((a, b) => {
        const fc = a.filePrefix.localeCompare(b.filePrefix); if (fc !== 0) return fc;
        const ma = a.text.match(sortRegex), mb = b.text.match(sortRegex);
        const na = ma ? parseInt(ma[1], 10) : Number.MAX_SAFE_INTEGER;
        const nb = mb ? parseInt(mb[1], 10) : Number.MAX_SAFE_INTEGER;
        return na - nb;
      });

      imageResults.innerHTML = ''; imageResultsHeader.classList.toggle('hidden', capturedImages.length === 0);

      capturedImages.forEach((imgData, index) => {
        const row = document.createElement('div');
        row.className = 'result-item flex flex-col md:flex-row items-center gap-6 p-4 border-b border-white/5 bg-surface-container rounded-xl mb-3 hover:bg-surface-container-high/50 transition-colors';

        const left = document.createElement('div');
        left.className = 'relative rounded-xl p-2 bg-[#141218] flex flex-col items-center group w-full md:w-1/3 border border-white/10 shadow-inner';

        const imgWrap = document.createElement('div');
        imgWrap.className = 'cursor-pointer w-full flex justify-center';
        imgWrap.onclick = () => openPdfViewer(imgData.sourceFile, imgData.page, imgData.text);

        const numSpan = document.createElement('span');
        numSpan.textContent = `${index + 1}.`;
        numSpan.className = 'absolute top-3 left-3 text-xs font-bold text-gray-500 bg-black/40 px-2 py-1 rounded';

        const excl = document.createElement('button');
        excl.innerHTML = '&times;';
        excl.className = 'exclude-btn absolute top-2 right-2 text-xl font-bold text-error bg-surface-container/80 rounded-full h-8 w-8 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all hover:bg-surface-container';
        excl.onclick = (e) => { e.stopPropagation(); toggleExclude(index, row); };

        const img = document.createElement('img');
        img.src = imgData.dataUrl; img.className = 'rounded border border-white/5 mb-3 max-w-full';
        imgWrap.append(img);

        const p = document.createElement('p');
        p.className = 'text-sm font-mono text-primary tracking-wide break-all text-center';
        const baseNumber = (imgData.text.match(baseNumberRegex) || [imgData.text])[0];
        p.textContent = `${imgData.filePrefix}${baseNumber} (pg ${imgData.page})`;

        const rev = document.createElement('span');
        rev.className = 'text-xs text-tertiary font-bold ml-2';
        if (includeRevisionCheckbox.checked && imgData.revision) rev.textContent = imgData.revision;

        const label = document.createElement('div');
        label.className = 'flex items-center justify-center';
        label.append(p, rev);

        left.append(numSpan, excl, imgWrap, label);

        const ta = document.createElement('textarea');
        ta.className = 'w-full md:w-2/3 h-28 p-3 rounded-xl bg-surface-container-high text-gray-200 border border-outline/30 focus:ring-2 focus:ring-primary focus:border-transparent outline-none resize-none';
        ta.placeholder = "Enter comments here...";
        ta.value = imgData.comment || '';
        ta.oninput = () => { capturedImages[index].comment = ta.value; };

        row.append(left, ta);
        imageResults.appendChild(row);
      });

      updateResultSummary();
    }

    function downloadFile(content, fileName, mimeType, withBOM = false) {
      const BOM = '\uFEFF';
      const blob = new Blob(withBOM ? [BOM, content] : [content], { type: mimeType });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = fileName;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
    }

    function generateSingleFileCsv(fileObj) {
      const activeMatches = fileObj.scanResult.matches;
      if (!activeMatches || activeMatches.length === 0) return;

      const baseNumberRegex = getBaseNumberRegex();

      const revMatch = fileObj.name.match(/_r?(\d+)/i);
      const revision = revMatch ? `r${revMatch[1]}` : null;
      const filePrefix = fileObj.name.toUpperCase().startsWith('EST-') ? fileObj.name.substring(4, 10) : fileObj.name.substring(0, 10);

      let dataForCsv = activeMatches.map(matchText => ({
        text: matchText,
        filePrefix: filePrefix,
        revision: revision,
        comment: ''
      }));

      dataForCsv.sort((a, b) => {
        const fullNumberA = `${a.filePrefix}${(a.text.match(baseNumberRegex) || [a.text])[0]}`;
        const fullNumberB = `${b.filePrefix}${(b.text.match(baseNumberRegex) || [b.text])[0]}`;
        return fullNumberA.localeCompare(fullNumberB, undefined, { numeric: true, sensitivity: 'base' });
      });

      if (filterCsvDuplicatesCheckbox.checked) {
        const map = new Map();
        dataForCsv.forEach(img => {
          const base = (img.text.match(baseNumberRegex) || [img.text])[0];
          const key = `${img.filePrefix}${base}`;
          if (!map.has(key) || img.text.length > map.get(key).text.length) {
            map.set(key, img);
          }
        });
        dataForCsv = [...map.values()];
      }

      let csv = [
        "Esliide", "Jrk nr.", "Revision", "Job", "Repaired", "Liide", "WPS nr.", "WPAR / WPQR nr.",
        "Keevitus protsess", "Keevitaja ID", "Keevituse tüüp", "Märkused", "Keevitaja 1",
        "Keevitaja 2", "IP 100%", "F/P/W", "Kuupäev", "RT %", "MT %", "PT %",
        "PMI QTY", "Fin.Qty", "Preheat", "PWHT"
      ].join(',') + '\n';

      dataForCsv.forEach(img => {
        const base = (img.text.match(baseNumberRegex) || [img.text])[0];
        const fullNumber = `${img.filePrefix}${base}`;

        let esliide = `"${fullNumber}"`;
        let jrkNr = "";

        const match = fullNumber.match(/^(.*?)(\d+)$/);
        if (match) {
          esliide = `"${match[1]}"`;
          jrkNr = `"${match[2]}"`;
        }

        const revisionCsv = `"${(includeRevisionCheckbox.checked && img.revision) ? img.revision : ''}"`;
        const comment = `""`;

        const row = [
          esliide, jrkNr, revisionCsv,
          "", "", "", "", "", "", "", "", comment, "", "", "", "", "", "", "", "", "", "", "", ""
        ];

        csv += row.join(',') + "\n";
      });

      const fileName = `report_${getPrefix()}_${fileObj.name.replace(/\.pdf$/i, '')}.csv`;
      downloadFile(csv, fileName, 'text/csv;charset=utf-8;', true);
    }

    // --- Export buttons ---
    generateReportBtn.addEventListener('click', async () => {
      const active = capturedImages.filter(img => !img.excluded);
      if (active.length === 0) return;

      const baseNumberRegex = getBaseNumberRegex();
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'portrait', format: 'a4' });

      doc.setFont('Helvetica', 'normal');

      const margin = 10, pageHeight = doc.internal.pageSize.getHeight(), pageWidth = doc.internal.pageSize.getWidth();
      let y = margin + 5;

      doc.setFontSize(16);
      doc.text("PDF Analysis Report", pageWidth / 2, y, { align: 'center' });
      y += 15;

      const captureWidth = parseInt(captureWidthInput.value) || 400;
      const captureHeight = parseInt(captureHeightInput.value) || 175;
      const imgWidth = 45;
      const imgHeight = (imgWidth / captureWidth) * captureHeight;

      active.forEach((imgData, index) => {
        const baseNumber = (imgData.text.match(baseNumberRegex) || [imgData.text])[0];
        let label = `${imgData.filePrefix}${baseNumber} ( page ${imgData.page} )`;
        if (includeRevisionCheckbox.checked && imgData.revision) label += ` ${imgData.revision}`;

        const commentLines = doc.splitTextToSize(imgData.comment || '', pageWidth - margin * 2 - imgWidth - 25);
        const textHeight = (commentLines.length + 2) * 4;
        const rowHeight = Math.max(imgHeight, textHeight) + 10;

        if (y + rowHeight > pageHeight - margin) { doc.addPage(); doc.setFont('Helvetica', 'normal'); y = margin; }

        doc.setDrawColor(150, 150, 150);
        doc.rect(margin, y, pageWidth - margin * 2, rowHeight);

        doc.setFontSize(10);
        doc.text(`${index + 1}.`, margin + 3, y + rowHeight / 2 + 3);

        const imgX = margin + 10, imgY = y + (rowHeight - imgHeight) / 2;
        doc.addImage(imgData.dataUrl, 'PNG', imgX, imgY, imgWidth, imgHeight);

        let textY = y + 7;
        doc.setFontSize(10).text(label, margin + 20 + imgWidth, textY);
        textY += 6;
        doc.setFontSize(9).text(commentLines, margin + 20 + imgWidth, textY);

        y += rowHeight;
      });

      const totalPages = doc.internal.getNumberOfPages();
      const footerText = "PDF Number Extractor";

      for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setFont('Helvetica', 'normal');
        doc.setFontSize(8);
        doc.text(footerText, margin, pageHeight - (margin / 2));
        const pageNumText = `Page ${i} of ${totalPages}`;
        const textWidth = doc.getStringUnitWidth(pageNumText) * doc.internal.getFontSize() / doc.internal.scaleFactor;
        doc.text(pageNumText, pageWidth - margin - textWidth, pageHeight - (margin / 2));
      }

      doc.save('pdf_analysis_report.pdf');
    });

    exportTxtBtn.addEventListener('click', () => {
      const active = capturedImages.filter(img => !img.excluded);
      if (active.length === 0) return;
      const baseNumberRegex = getBaseNumberRegex();
      const unique = [...new Set(active.map(img => {
        const base = (img.text.match(baseNumberRegex) || [img.text])[0];
        return `${img.filePrefix}${base}`;
      }))].sort((a, b) => a.localeCompare(b));
      downloadFile(unique.join('\n'), 'prefixed_numbers_unique.txt', 'text/plain;charset=utf-8;', true);
    });

    exportCsvBtn.addEventListener('click', () => {
      const active = capturedImages.filter(img => !img.excluded);
      if (active.length === 0) return;
      const baseNumberRegex = getBaseNumberRegex();

      let dataForCsv = active;
      if (filterCsvDuplicatesCheckbox.checked) {
        const map = new Map();
        active.forEach(img => {
          const base = (img.text.match(baseNumberRegex) || [img.text])[0];
          const key = `${img.filePrefix}${base}`;
          if (!map.has(key) || img.text.length > map.get(key).text.length) map.set(key, img);
        });
        dataForCsv = [...map.values()];
      }

      let csv = [
        "Esliide", "Jrk nr.", "Revision", "Job", "Repaired", "Liide", "WPS nr.", "WPAR / WPQR nr.",
        "Keevitus protsess", "Keevitaja ID", "Keevituse tüüp", "Märkused", "Keevitaja 1",
        "Keevitaja 2", "IP 100%", "F/P/W", "Kuupäev", "RT %", "MT %", "PT %",
        "PMI QTY", "Fin.Qty", "Preheat", "PWHT"
      ].join(';') + '\n';

      dataForCsv.forEach(img => {
        const base = (img.text.match(baseNumberRegex) || [img.text])[0];
        const fullNumber = `${img.filePrefix}${base}`;

        let esliide = `"${fullNumber}"`;
        let jrkNr = "";

        const match = fullNumber.match(/^(.*?)(\d+)$/);
        if (match) {
          esliide = `"${match[1]}"`;
          jrkNr = `"${match[2]}"`;
        }

        const revision = `"${(includeRevisionCheckbox.checked && img.revision) ? img.revision : ''}"`;
        const comment = `"${(img.comment || '').replace(/"/g, '""')}"`;

        const row = [
          esliide, jrkNr, revision,
          "", "", "", "", "", "", "", "", comment, "", "", "", "", "", "", "", "", "", "", "", ""
        ];

        csv += row.join(';') + "\n";
      });

      const csvWithBom = '\uFEFF' + csv;
      downloadFile(csvWithBom, 'welding_report_export.csv', 'text/csv;charset=utf-8;', true);
    });

    // --- Init ---
    window.onload = async () => {
      updateCapturePreview(); renderFileList();
    };
  </script>
</body>

</html>