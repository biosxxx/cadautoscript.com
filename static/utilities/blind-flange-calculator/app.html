<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EN 13445 Blind Flange Calculator</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #fdfcff; /* MD3 Surface */
            color: #1a1c1e;
        }
        
        /* Custom MD3 utilities */
        .md-surface-container {
            background-color: #f0f4f8; 
        }
        .md-surface-high {
            background-color: #eaddff;
        }
        .md-primary {
            color: #6750a4;
        }
        .md-primary-bg {
            background-color: #6750a4;
        }
        .md-on-primary {
            color: #ffffff;
        }
        .md-card {
            border-radius: 24px;
            transition: all 0.3s ease;
        }
        .md-input-field {
            position: relative;
            background-color: #e7e0ec;
            border-radius: 8px 8px 0 0;
            border-bottom: 2px solid #49454f;
            padding: 24px 16px 8px;
            font-size: 16px;
            transition: all 0.2s;
        }
        .md-input-field:focus-within {
            background-color: #eaddff;
            border-bottom-color: #6750a4;
        }
        .md-label {
            position: absolute;
            top: 18px;
            left: 16px;
            font-size: 16px;
            color: #49454f;
            transition: all 0.2s;
            pointer-events: none;
        }
        .md-input-field input:focus ~ .md-label,
        .md-input-field input:not(:placeholder-shown) ~ .md-label,
        .md-input-field select:focus ~ .md-label,
        .md-input-field select:valid ~ .md-label {
            top: 4px;
            font-size: 12px;
            color: #6750a4;
        }
        
        .blueprint-grid {
            background-image: linear-gradient(#e5e7eb 1px, transparent 1px),
            linear-gradient(90deg, #e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Material Symbols sizing */
        .material-symbols-outlined {
          font-variation-settings:
          'FILL' 0,
          'wght' 400,
          'GRAD' 0,
          'opsz' 24
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- DATASETS ---

        // Material Properties (Simplified Yield Strengths MPa at Temp)
        // Based on EN 10028-2 and EN 10028-7
        const MATERIALS = {
            "P265GH": { 
                name: "P265GH (1.0425)", 
                yield: { 20: 265, 100: 243, 150: 228, 200: 215, 250: 204, 300: 194, 350: 184, 400: 173 },
                density: 7.85
            },
            "P355GH": { 
                name: "P355GH (1.0473)", 
                yield: { 20: 355, 100: 329, 150: 312, 200: 298, 250: 285, 300: 271, 350: 258, 400: 247 },
                density: 7.85
            },
            "1.4404": { 
                name: "1.4404 (316L)", 
                yield: { 20: 220, 100: 195, 150: 175, 200: 165, 250: 155, 300: 145, 350: 140, 400: 135 },
                density: 7.9
            }
        };

        // EN 1092-1 DIMENSIONS DATABASE
        // Structure: [DN]: { [PN]: { D, k, bolts, size, d2 } }
        const EN1092_DB = {
            15: {
                16: { D: 95, k: 65, bolts: 4, size: "M12", d2: 14 },
                40: { D: 95, k: 65, bolts: 4, size: "M12", d2: 14 },
                100: { D: 105, k: 75, bolts: 4, size: "M12", d2: 14 }
            },
            25: {
                16: { D: 115, k: 85, bolts: 4, size: "M12", d2: 14 },
                40: { D: 115, k: 85, bolts: 4, size: "M12", d2: 14 },
                100: { D: 140, k: 100, bolts: 4, size: "M16", d2: 18 }
            },
            50: {
                16: { D: 165, k: 125, bolts: 4, size: "M16", d2: 18 },
                40: { D: 165, k: 125, bolts: 4, size: "M16", d2: 18 },
                63: { D: 180, k: 135, bolts: 4, size: "M20", d2: 22 },
                100: { D: 195, k: 145, bolts: 4, size: "M24", d2: 26 }
            },
            80: {
                16: { D: 200, k: 160, bolts: 8, size: "M16", d2: 18 },
                40: { D: 200, k: 160, bolts: 8, size: "M16", d2: 18 },
                63: { D: 215, k: 170, bolts: 8, size: "M20", d2: 22 },
                100: { D: 230, k: 180, bolts: 8, size: "M24", d2: 26 }
            },
            100: {
                16: { D: 220, k: 180, bolts: 8, size: "M16", d2: 18 },
                40: { D: 235, k: 190, bolts: 8, size: "M20", d2: 22 },
                63: { D: 250, k: 200, bolts: 8, size: "M24", d2: 26 },
                100: { D: 265, k: 210, bolts: 8, size: "M27", d2: 30 }
            },
            150: {
                16: { D: 285, k: 240, bolts: 8, size: "M20", d2: 22 },
                40: { D: 300, k: 250, bolts: 8, size: "M24", d2: 26 },
                63: { D: 345, k: 280, bolts: 8, size: "M30", d2: 33 },
                100: { D: 355, k: 290, bolts: 12, size: "M30", d2: 33 }
            },
            200: {
                10: { D: 340, k: 295, bolts: 8, size: "M20", d2: 22 },
                16: { D: 340, k: 295, bolts: 12, size: "M20", d2: 22 },
                25: { D: 360, k: 310, bolts: 12, size: "M24", d2: 26 },
                40: { D: 375, k: 320, bolts: 12, size: "M30", d2: 33 }, 
                63: { D: 415, k: 345, bolts: 12, size: "M36", d2: 39 },
                100: { D: 430, k: 360, bolts: 16, size: "M36", d2: 39 }
            },
            300: {
                10: { D: 445, k: 400, bolts: 12, size: "M20", d2: 22 },
                16: { D: 460, k: 410, bolts: 12, size: "M24", d2: 26 },
                25: { D: 485, k: 430, bolts: 16, size: "M27", d2: 30 },
                40: { D: 515, k: 450, bolts: 16, size: "M33", d2: 36 },
                63: { D: 555, k: 490, bolts: 16, size: "M36", d2: 39 }
            },
            400: {
                10: { D: 565, k: 515, bolts: 16, size: "M24", d2: 26 },
                16: { D: 580, k: 525, bolts: 16, size: "M27", d2: 30 },
                25: { D: 620, k: 550, bolts: 16, size: "M36", d2: 39 },
                40: { D: 660, k: 585, bolts: 16, size: "M39", d2: 42 }
            },
            500: {
                10: { D: 670, k: 620, bolts: 20, size: "M24", d2: 26 },
                16: { D: 715, k: 650, bolts: 20, size: "M30", d2: 33 },
                25: { D: 730, k: 660, bolts: 20, size: "M36", d2: 39 },
                40: { D: 755, k: 670, bolts: 20, size: "M45", d2: 48 }
            },
            600: {
                10: { D: 780, k: 725, bolts: 20, size: "M27", d2: 30 },
                16: { D: 840, k: 770, bolts: 20, size: "M33", d2: 36 },
                25: { D: 845, k: 770, bolts: 20, size: "M36", d2: 39 },
                40: { D: 890, k: 795, bolts: 20, size: "M48", d2: 52 }
            },
            700: {
                10: { D: 895, k: 840, bolts: 24, size: "M27", d2: 30 },
                16: { D: 910, k: 840, bolts: 24, size: "M33", d2: 36 },
                25: { D: 960, k: 875, bolts: 24, size: "M42", d2: 45 },
                40: { D: 995, k: 900, bolts: 24, size: "M48", d2: 52 }
            },
            800: {
                10: { D: 1015, k: 950, bolts: 24, size: "M30", d2: 33 },
                16: { D: 1025, k: 950, bolts: 24, size: "M36", d2: 39 },
                25: { D: 1085, k: 990, bolts: 24, size: "M48", d2: 52 },
                40: { D: 1140, k: 1030, bolts: 24, size: "M52", d2: 56 }
            },
            900: {
                10: { D: 1115, k: 1050, bolts: 28, size: "M30", d2: 33 },
                16: { D: 1125, k: 1050, bolts: 28, size: "M36", d2: 39 },
                25: { D: 1185, k: 1090, bolts: 28, size: "M48", d2: 52 },
                40: { D: 1250, k: 1140, bolts: 28, size: "M52", d2: 56 }
            },
            1000: {
                10: { D: 1230, k: 1160, bolts: 28, size: "M33", d2: 36 },
                16: { D: 1255, k: 1170, bolts: 28, size: "M39", d2: 42 },
                25: { D: 1320, k: 1210, bolts: 28, size: "M52", d2: 56 },
                40: { D: 1360, k: 1250, bolts: 28, size: "M56", d2: 62 }
            },
            1200: {
                10: { D: 1455, k: 1380, bolts: 32, size: "M36", d2: 39 },
                16: { D: 1485, k: 1390, bolts: 32, size: "M45", d2: 48 },
                25: { D: 1530, k: 1420, bolts: 32, size: "M52", d2: 56 },
                40: { D: 1575, k: 1460, bolts: 32, size: "M64", d2: 70 }
            }
        };

        const AVAILABLE_DNS = [15, 25, 50, 80, 100, 150, 200, 300, 400, 500, 600, 700, 800, 900, 1000, 1200];

        // --- COMPONENTS ---

        const FlangeVisualizer = ({ dn, dims, calculatedThickness, pn }) => {
            if (!dims) return <div className="p-4 bg-gray-100 rounded text-center">No data for this configuration</div>;

            const scale = 260 / dims.D; // Fit to SVG viewbox
            const cx = 150;
            const cy = 150;
            
            const boltPoints = [];
            for (let i = 0; i < dims.bolts; i++) {
                const angle = (2 * Math.PI * i) / dims.bolts;
                boltPoints.push({
                    x: cx + (dims.k / 2) * Math.cos(angle) * scale,
                    y: cy + (dims.k / 2) * Math.sin(angle) * scale
                });
            }

            return (
                <div className="flex flex-col items-center justify-center p-4 bg-white rounded-3xl shadow-sm blueprint-grid border border-gray-200 h-full min-h-[300px]">
                    <h3 className="text-sm font-bold text-gray-500 mb-2 uppercase tracking-wider">Sketch (PN {pn})</h3>
                    <svg width="300" height="300" viewBox="0 0 300 300">
                        {/* Flange Body */}
                        <circle cx={cx} cy={cy} r={(dims.D / 2) * scale} fill="#eaddff" stroke="#6750a4" strokeWidth="2" />
                        
                        {/* Raised Face / Gasket Area (Approx) */}
                        <circle cx={cx} cy={cy} r={(dims.k / 2 - 20) * scale} fill="none" stroke="#6750a4" strokeWidth="1" strokeDasharray="4 2" />
                        
                        {/* Bolt Circle */}
                        <circle cx={cx} cy={cy} r={(dims.k / 2) * scale} fill="none" stroke="#6750a4" strokeWidth="0.5" opacity="0.5" />
                        
                        {/* Bolts */}
                        {boltPoints.map((p, i) => (
                            <circle key={i} cx={p.x} cy={p.y} r={(dims.d2 / 2) * scale} fill="white" stroke="#1a1c1e" strokeWidth="1" />
                        ))}

                        {/* Center Text */}
                        <text x={cx} y={cy} textAnchor="middle" dy=".3em" fontSize="14" fill="#6750a4" fontWeight="bold">DN{dn}</text>
                    </svg>
                    <div className="mt-4 text-center text-xs text-gray-500">
                        <p>Outer D: {dims.D} mm</p>
                        <p>Bolt Circle K: {dims.k} mm</p>
                        <p>Bolts: {dims.bolts} x ({dims.size})</p>
                    </div>
                </div>
            );
        };

        const ResultCard = ({ label, value, unit, subtext, icon, highlight = false }) => (
            <div className={`p-4 rounded-2xl flex items-center gap-4 ${highlight ? 'bg-[#eaddff] text-[#21005d]' : 'bg-[#f0f4f8] text-[#1a1c1e]'}`}>
                <span className="material-symbols-outlined text-3xl">{icon}</span>
                <div>
                    <p className="text-xs font-medium opacity-70 uppercase tracking-wide">{label}</p>
                    <p className="text-2xl font-bold leading-none">{value} <span className="text-base font-normal opacity-60">{unit}</span></p>
                    {subtext && <p className="text-xs mt-1 opacity-80">{subtext}</p>}
                </div>
            </div>
        );

        const App = () => {
            // State
            const [dn, setDn] = React.useState(100);
            const [pressureOp, setPressureOp] = React.useState(10);
            const [pressureTest, setPressureTest] = React.useState(15); 
            const [temp, setTemp] = React.useState(20);
            const [material, setMaterial] = React.useState("P265GH");
            const [corr, setCorr] = React.useState(1);
            const [manualTest, setManualTest] = React.useState(false); // check if user manually edited test pressure

            // Logic to determine PN based on Operating Pressure
            const getCalculatedPN = (pressure) => {
                if (pressure <= 10) return 10;
                if (pressure <= 16) return 16;
                if (pressure <= 25) return 25;
                if (pressure <= 40) return 40;
                if (pressure <= 63) return 63;
                return 100;
            };

            // Calculation Logic
            const calculate = () => {
                const targetPN = getCalculatedPN(pressureOp);
                
                // Get dims for this DN and closest available PN
                // Logic: find closest existing PN in database >= targetPN
                const availablePNs = EN1092_DB[dn] ? Object.keys(EN1092_DB[dn]).map(Number).sort((a,b) => a-b) : [];
                let selectedPN = availablePNs.find(pn => pn >= targetPN);
                
                // If pressure is super high and no data, take max available
                if (!selectedPN && availablePNs.length > 0) selectedPN = availablePNs[availablePNs.length - 1];
                
                // If still undefined (data missing), fallback to a default structure to prevent crash
                if (!selectedPN) return null; 

                const dims = EN1092_DB[dn][selectedPN];
                
                // Material Properties Interpolation
                const matData = MATERIALS[material];
                const getYield = (t) => {
                    const temps = Object.keys(matData.yield).map(Number).sort((a,b) => a-b);
                    let lower = temps[0];
                    for(let T of temps) { if(T <= t) lower = T; }
                    return matData.yield[lower] || 150;
                };

                const Re_op = getYield(temp);
                const Re_test = getYield(20);

                const f_op = Re_op / 1.5;
                const f_test = Re_test / 1.05;

                const G = dims.k - 20; 
                const leverArm = (dims.k - G) / 2;
                
                const Force_op = (Math.PI * Math.pow(G/2, 2)) * pressureOp * 0.1;
                const Force_test = (Math.PI * Math.pow(G/2, 2)) * pressureTest * 0.1;

                const M_op = (Force_op * 1.3) * leverArm; 
                const M_test = (Force_test * 1.1) * leverArm; 

                const e_op_calc = Math.sqrt( (6 * M_op) / (Math.PI * G * f_op) );
                const e_test_calc = Math.sqrt( (6 * M_test) / (Math.PI * G * f_test) );

                const e_min_calc = Math.max(e_op_calc, e_test_calc);
                const e_final = e_min_calc + parseFloat(corr);
                
                // Expanded standard thickness list for large flanges
                const standards = [6, 8, 10, 12, 14, 15, 16, 18, 20, 22, 25, 28, 30, 35, 40, 45, 50, 60, 70, 80, 90, 100, 110, 120, 130, 140, 150];
                const e_recommended = standards.find(s => s >= e_final) || Math.ceil(e_final);

                return {
                    dims,
                    selectedPN,
                    f_op: f_op.toFixed(1),
                    f_test: f_test.toFixed(1),
                    e_min: e_min_calc.toFixed(2),
                    e_final: e_final.toFixed(2),
                    e_rec: e_recommended,
                    weight: (Math.PI * Math.pow(dims.D/2000, 2) * (e_recommended/1000) * matData.density * 1000).toFixed(1)
                };
            };

            const res = calculate();

            // Auto-update Test Pressure if Op Pressure changes, ONLY if user hasn't manually set it this session
            React.useEffect(() => {
                if (!manualTest) {
                    setPressureTest(Math.round(pressureOp * 1.43));
                }
            }, [pressureOp]);

            return (
                <div className="max-w-6xl mx-auto p-4 md:p-8">
                    <header className="mb-8">
                        <div className="inline-flex items-center gap-2 bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full text-sm font-medium mb-2">
                            <span className="material-symbols-outlined text-sm">engineering</span>
                            EN 13445-3 & EN 1092-1
                        </div>
                        <h1 className="text-4xl font-bold md-primary">Blind Flange Calculation</h1>
                        <p className="text-gray-500 mt-2 text-lg">Automatic PN selection and thickness calculation</p>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        
                        {/* INPUT COLUMN */}
                        <div className="lg:col-span-4 flex flex-col gap-6">
                            <section className="bg-white p-6 rounded-[24px] shadow-sm border border-gray-100">
                                <h2 className="text-xl font-bold mb-6 flex items-center gap-2">
                                    <span className="material-symbols-outlined text-gray-400">tune</span>
                                    Parameters
                                </h2>
                                
                                <div className="space-y-4">
                                    <div className="md-input-field">
                                        <select 
                                            value={dn} 
                                            onChange={(e) => setDn(Number(e.target.value))}
                                            className="w-full bg-transparent outline-none pt-1"
                                        >
                                            {AVAILABLE_DNS.map(d => (
                                                <option key={d} value={d}>DN {d}</option>
                                            ))}
                                        </select>
                                        <label className="md-label">Diameter (DN)</label>
                                    </div>

                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="md-input-field">
                                            <input 
                                                type="number" 
                                                value={pressureOp} 
                                                onChange={(e) => {
                                                    setPressureOp(Number(e.target.value));
                                                    setManualTest(false);
                                                }}
                                                className="w-full bg-transparent outline-none pt-1" 
                                                placeholder=" "
                                            />
                                            <label className="md-label">Op. Pressure (bar)</label>
                                        </div>
                                        <div className="md-input-field">
                                            <input 
                                                type="number" 
                                                value={pressureTest} 
                                                onChange={(e) => {
                                                    setPressureTest(Number(e.target.value));
                                                    setManualTest(true);
                                                }}
                                                className="w-full bg-transparent outline-none pt-1" 
                                                placeholder=" "
                                            />
                                            <label className="md-label">Test Pressure (bar)</label>
                                        </div>
                                    </div>

                                    <div className="md-input-field">
                                        <input 
                                            type="number" 
                                            value={temp} 
                                            onChange={(e) => setTemp(Number(e.target.value))}
                                            className="w-full bg-transparent outline-none pt-1" 
                                            placeholder=" "
                                        />
                                        <label className="md-label">Temperature (Â°C)</label>
                                    </div>

                                    <div className="md-input-field">
                                        <select 
                                            value={material} 
                                            onChange={(e) => setMaterial(e.target.value)}
                                            className="w-full bg-transparent outline-none pt-1"
                                        >
                                            {Object.keys(MATERIALS).map(m => (
                                                <option key={m} value={m}>{MATERIALS[m].name}</option>
                                            ))}
                                        </select>
                                        <label className="md-label">Material</label>
                                    </div>

                                    <div className="md-input-field">
                                        <input 
                                            type="number" 
                                            value={corr} 
                                            onChange={(e) => setCorr(Number(e.target.value))}
                                            className="w-full bg-transparent outline-none pt-1" 
                                            placeholder=" "
                                            step="0.5"
                                        />
                                        <label className="md-label">Corrosion (mm)</label>
                                    </div>
                                </div>
                            </section>

                            <div className="p-4 rounded-2xl bg-blue-50 text-blue-800 text-sm flex gap-3">
                                <span className="material-symbols-outlined">info</span>
                                <div>
                                    <p className="font-bold">PN Selection Logic</p>
                                    <p>Bolt and flange dimensions are automatically selected according to EN 1092-1 based on operating pressure (P{pressureOp} &rarr; PN{res ? res.selectedPN : '?'}).</p>
                                </div>
                            </div>
                        </div>

                        {/* RESULTS COLUMN */}
                        <div className="lg:col-span-8 flex flex-col gap-6">
                            
                            {res ? (
                                <>
                                    {/* Main Result */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <ResultCard 
                                            highlight={true}
                                            icon="layers"
                                            label="Rec. Thickness"
                                            value={res.e_rec}
                                            unit="mm"
                                            subtext={`Calculated: ${res.e_final} mm`}
                                        />
                                        <ResultCard 
                                            icon="weight"
                                            label="Flange Weight"
                                            value={res.weight}
                                            unit="kg"
                                            subtext="Steel"
                                        />
                                    </div>

                                    {/* Details Grid */}
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <ResultCard 
                                            icon="bolt"
                                            label={`Bolts (PN${res.selectedPN})`}
                                            value={res.dims.bolts}
                                            unit="qty"
                                            subtext={`Thread ${res.dims.size}`}
                                        />
                                        <ResultCard 
                                            icon="circle"
                                            label="Gasket"
                                            value={`~${res.dims.k - 30}`}
                                            unit="mm"
                                            subtext="Mean Dia"
                                        />
                                        <ResultCard 
                                            icon="compress"
                                            label="Op. Stress"
                                            value={res.f_op}
                                            unit="MPa"
                                            subtext="Allowable"
                                        />
                                        <ResultCard 
                                            icon="science"
                                            label="Test Stress"
                                            value={res.f_test}
                                            unit="MPa"
                                            subtext="Allowable"
                                        />
                                    </div>

                                    {/* Visualization */}
                                    <div className="flex-grow">
                                        <FlangeVisualizer dn={dn} dims={res.dims} calculatedThickness={res.e_rec} pn={res.selectedPN} />
                                    </div>

                                    {/* Specs Table */}
                                    <div className="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 overflow-x-auto">
                                        <h3 className="font-bold mb-4">Calculation Details (EN 13445-3)</h3>
                                        <table className="w-full text-sm text-left">
                                            <thead className="text-gray-500 border-b">
                                                <tr>
                                                    <th className="py-2">Parameter</th>
                                                    <th className="py-2">Value</th>
                                                    <th className="py-2">Comment</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr className="border-b border-gray-50">
                                                    <td className="py-2 font-medium">Selected Class (PN)</td>
                                                    <td className="py-2">PN {res.selectedPN}</td>
                                                    <td className="text-gray-500">Nearest standard >= {pressureOp} bar</td>
                                                </tr>
                                                <tr className="border-b border-gray-50">
                                                    <td className="py-2 font-medium">Min. Thickness (e_min)</td>
                                                    <td className="py-2">{res.e_min} mm</td>
                                                    <td className="text-gray-500">Excluding corrosion</td>
                                                </tr>
                                                <tr className="border-b border-gray-50">
                                                    <td className="py-2 font-medium">Bolt Size</td>
                                                    <td className="py-2">{res.dims.bolts} x {res.dims.size}</td>
                                                    <td className="text-gray-500">On circle {res.dims.k} mm</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </>
                            ) : (
                                <div className="p-8 bg-red-50 text-red-800 rounded-2xl text-center">
                                    <h3 className="font-bold text-xl">No Data</h3>
                                    <p>No standard data found for selected diameter (DN{dn}) and pressure ({pressureOp} bar).</p>
                                </div>
                            )}

                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>